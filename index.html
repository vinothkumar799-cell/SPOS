<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sri Parvathi Oil Stores — Billing App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- QR Code Generator Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <!-- Barcode/QR Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    /* --------------------------------------------------
       CORE THEME
       -------------------------------------------------- */
    :root {
      --app-bg: #0f172a;
      --card: #0b1120;
      --card-2: #020617;
      --primary: #f97316;
      --primary-2: #facc15;
      --primary-soft: rgba(249, 115, 22, 0.15);
      --text-on-bg: #e5e7eb;
      --muted: #9ca3af;
      --muted-100: #1e293b;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.15);
      --warning: #f59e0b; /* Yellow for low stock */
      --warning-soft: rgba(245, 158, 11, 0.15);
      --success: #22c55e;
      --blue-1: #2563eb;
      --blue-2: #1d4ed8;
      --card-shadow: 0 18px 40px rgba(15,23,42,0.9);
      --radius-lg: 14px;
      --radius-md: 10px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text-on-bg);
      min-height: 100vh;
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding-bottom: 60px; /* Space for mobile bottom nav */
    }

    /* Disable mouse wheel scrolling on number inputs */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    /* OFFLINE BANNER */
    #offline-banner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--danger);
      color: #fff;
      text-align: center;
      padding: 4px;
      font-size: 13px;
      font-weight: 600;
      z-index: 1001;
    }
    #offline-banner.visible {
      display: block;
    }


    /* APP SHELL */
    #app-shell {
      display: block; /* app always visible (login removed) */
      width: 100%;
      max-width: 1400px;
      margin: 16px auto;
      padding: 10px;
      gap: 18px;
    }

    .app-shell-inner {
      display: flex;
      gap: 18px;
      width: 100%;
    }

    nav.left-nav {
      width: 220px;
      min-width: 220px;
      background: radial-gradient(circle at top left, rgba(249,115,22,0.18), rgba(15,23,42,1));
      border-radius: 18px;
      padding: 18px 16px 14px;
      box-shadow: var(--card-shadow);
      position: sticky;
      top: 12px;
      height: calc(100vh - 32px);
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(148,163,184,0.35);
      z-index: 100;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-weight: 800;
      background: conic-gradient(from 210deg, #f97316, #facc15, #f97316);
      box-shadow: 0 10px 25px rgba(249,115,22,0.4);
    }

    .brand-text {
      font-weight: 700;
      font-size: 15px;
      line-height: 1.2;
    }
    .brand-text small {
      font-weight: 500;
      color: var(--muted);
      font-size: 12px;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-list a {
      display: block;
      padding: 8px 10px;
      border-radius: 999px;
      text-decoration: none;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      transition: background 0.12s ease, color 0.12s ease, transform 0.08s ease;
    }

    .nav-list a:hover {
      background: rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }

    .nav-list a.active {
      background: linear-gradient(90deg, rgba(249,115,22,0.08), rgba(250,204,21,0.08));
      color: #e5e7eb;
      border: 1px solid rgba(249,115,22,0.4);
      box-shadow: 0 0 0 1px rgba(30,64,175,0.6);
    }

    .nav-footer {
      margin-top: auto;
      padding-top: 12px;
      font-size: 11px;
      color: var(--muted);
      border-top: 1px solid rgba(148,163,184,0.3);
    }

    main { flex: 1; min-width: 0; }

    .container { max-width: 1050px; margin: 0 auto; }

    header.page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    header.page-header h1 {
      margin: 0;
      font-size: 20px;
    }

    header.page-header .muted { font-size: 13px; }

    .muted { color: var(--muted); }

    /* BUTTONS */
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      color: #020617;
      box-shadow: 0 14px 30px rgba(249,115,22,0.45);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(249,115,22,0.5);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.4);
    }

    .btn-ghost:hover:not(:disabled) {
      background: rgba(15,23,42,0.8);
    }

    .btn-secondary {
      background: rgba(15,23,42,1);
      border: 1px solid rgba(31,41,55,0.9);
      color: #e5e7eb;
    }

    .btn-danger {
      background: rgba(127,29,29,1);
      color: #fee2e2;
      border: 1px solid rgba(248,113,113,0.8);
    }

    .btn-print {
      background: linear-gradient(90deg,var(--blue-1),var(--blue-2));
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      border: 0;
      cursor: pointer;
    }
    
    .btn-info {
      background: rgba(30, 58, 138, 0.6);
      border: 1px solid rgba(96, 165, 250, 0.4);
      color: #bfdbfe;
    }

    /* CARDS, TABLES, ETC. */
    .card {
      border-radius: var(--radius-lg);
      padding: 14px 14px 12px;
      background: radial-gradient(circle at top left, rgba(148,163,184,0.04), var(--card-2));
      box-shadow: 0 18px 40px rgba(15,23,42,0.85);
      border: 1px solid rgba(30,64,175,0.55);
    }

    .card-subtle {
      border-radius: var(--radius-md);
      padding: 10px 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.8);
    }

    .label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input, select { font-family: inherit; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px 14px;
    }

    .form-grid.grid-4 {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .form-grid input,
    .form-grid select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(30,64,175,0.65);
      background: rgba(15,23,42,0.95);
      color: var(--text-on-bg);
      font-size: 14px;
      outline: none;
    }

    .form-grid input:focus,
    .form-grid select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(249,115,22,0.45);
    }

    .hidden { display: none !important; }

    .table-wrapper {
      max-height: 420px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.85);
      background: radial-gradient(circle at top, rgba(15,23,42,1), rgba(15,23,42,0.98));
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 100%;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: rgba(15,23,42,0.98);
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(31,41,55,0.7);
      white-space: nowrap;
    }

    th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: rgba(148,163,184,0.9);
    }

    td { color: #e5e7eb; }

    td.actions { white-space: nowrap; }

    .inventory-thumb {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid rgba(31,41,55,0.9);
    }

    .btn-small {
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      font-size: 11px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-small.edit {
      background: rgba(37,99,235,0.16);
      color: #bfdbfe;
      border: 1px solid rgba(37,99,235,0.6);
    }

    .btn-small.delete {
      background: rgba(239,68,68,0.12);
      color: #fecaca;
      border: 1px solid rgba(239,68,68,0.65);
    }
    
    .btn-small.label-btn {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.6);
    }

    .badge-pill {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
      font-size: 11px;
      font-weight: 500;
    }

    .badge-out-of-stock {
      background: var(--danger-soft);
      border-color: var(--danger);
      color: var(--danger);
      font-weight: 700;
    }

    .badge-low-stock {
      background: var(--warning-soft);
      border-color: var(--warning);
      color: var(--warning);
      font-weight: 700;
    }


    /* BILLING PAGE */
    .billing-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(320px, 1fr);
      gap: 16px;
    }

    .top-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }

    .customer-fields {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .customer-fields input {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(30,64,175,0.65);
      min-width: 170px;
      background: rgba(15,23,42,0.95);
      color: var(--text-on-bg);
    }

    .product-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 8px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,1));
      border: 1px solid rgba(31,41,55,0.9);
      max-height: 250px;
      overflow: auto;
    }

    .product-card {
      width: 150px;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 10px 8px; /* Increased tap area */
      background: linear-gradient(180deg, #020617, #020617);
      position: relative;
    }
    
    .product-card .stock-badge-corner {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 10px;
      padding: 2px 6px;
    }

    .product-card img {
      width: 100%;
      height: 90px;
      object-fit: cover;
      border-radius: 8px;
    }

    .product-card .title {
      font-size: 13px;
      font-weight: 700;
      text-align: center;
    }

    .product-card .meta {
      font-size: 12px;
      color: var(--muted);
    }

    .product-card.selected {
      outline: 2px solid rgba(249,115,22,0.7);
      box-shadow: 0 10px 25px rgba(15,23,42,0.9);
    }
    
    /* NEW: Search result item styles */
    .search-result-item {
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-item:hover {
      background: var(--primary-soft);
      color: var(--primary-2);
    }

    form.controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px;
    }

    form.controls input,
    form.controls select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,1);
      color: var(--text-on-bg);
      min-width: 80px;
      font-size: 13px;
    }

    .summary-box {
      padding: 10px 10px 8px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(15,23,42,0.98), #020617);
      border: 1px solid rgba(31,41,55,0.9);
      font-size: 13px;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .summary-line.tax-line {
      font-size: 12px;
      color: var(--muted);
    }

    .summary-line.big {
      font-size: 15px;
      margin-top: 4px;
    }

    .pill-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    /* REPORTS */
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .controls input,
    .controls select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,1);
      color: #e5e7eb;
      font-size: 13px;
    }

    .quick-presets {
      display: flex;
      gap: 4px;
    }

    .quick-presets .btn-ghost {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
    }

    .tabs {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      background: rgba(15,23,42,1);
      border: 1px solid rgba(31,41,55,0.9);
      flex-wrap: wrap; /* Allow tabs to wrap on mobile */
    }

    .tab {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab.active {
      background: radial-gradient(circle at top, rgba(249,115,22,0.14), rgba(15,23,42,1));
      color: #e5e7eb;
      border: 1px solid rgba(249,115,22,0.5);
    }

    .trend-layout {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    #top-items-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 200px;
      overflow: auto;
      padding-right: 4px;
      font-size: 13px;
    }

    .party-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15,23,42,1);
      border: 1px solid rgba(31,41,55,0.9);
      cursor: pointer;
    }

    .party-row:hover {
      border-color: rgba(249,115,22,0.6);
    }

    /* MODALS (print + settings) */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200; /* Increased to sit above nav */
    }

    .modal.open { display: flex; }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.8);
    }

    .modal-panel {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 420px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at top left, rgba(249,115,22,0.2), rgba(15,23,42,1));
      padding: 16px 16px 12px;
      box-shadow: 0 22px 50px rgba(0,0,0,0.9);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
    }

    .modal-body {
      font-size: 14px;
      color: #e5e7eb;
    }
    
    .modal-body input, .modal-body select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(30,64,175,0.65);
      background: rgba(15,23,42,0.95);
      color: var(--text-on-bg);
      font-size: 14px;
      outline: none;
    }

    .modal-meta {
      font-size: 13px;
      margin-top: 6px;
      color: #e5e7eb;
    }

    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .text-right { text-align: right; }
    .text-sm { font-size: 12px; }
    .text-xs { font-size: 11px; }

        /* -----------------------------------------
       TOAST NOTIFICATION
       ----------------------------------------- */
    #toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(120%);
      padding: 8px 14px;
      background: rgba(15,23,42,0.96);
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.75);
      font-size: 13px;
      color: var(--text-on-bg);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.18s ease-out, opacity 0.18s ease-out;
      z-index: 9999;
      white-space: nowrap;
      max-width: 90vw;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    /* UPI SECTION IN MODAL */
    #upi-section {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(148,163,184,0.2);
        display: none; /* Hidden by default until total calculated */
        text-align: center;
    }
    #upi-qr-canvas {
        margin: 8px auto;
        border: 4px solid #fff;
        border-radius: 8px;
        display: block;
    }
    
    /* SCANNER MODAL */
    #scanner-preview {
        width: 100%;
        height: 300px;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 10px;
    }


    /* -----------------------------------------
       RESPONSIVE (MOBILE) TWEAKS
       ----------------------------------------- */
    @media (max-width: 980px) {
      body { align-items: flex-start; }
      #app-shell { margin: 0; padding: 8px; }
      .app-shell-inner { flex-direction: column; }

      /* Mobile Bottom Nav Bar */
      nav.left-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px; /* Taller tap area */
        flex-direction: row;
        align-items: center;
        gap: 4px; /* Tighter gap */
        width: 100%;
        padding: 6px;
        border-radius: 18px 18px 0 0;
        top: auto;
        box-shadow: 0 -10px 30px rgba(15,23,42,1);
      }

      nav.left-nav .brand { display: none; } /* Hide brand on mobile nav */

      .nav-list {
        flex-direction: row;
        flex: 1;
        justify-content: space-around; /* Distribute items */
        align-items: center;
        flex-wrap: nowrap;
        margin: 0;
        height: 100%;
      }
      
      .nav-list li {
        flex: 1;
      }

      .nav-list a {
        font-size: 13px;
        padding: 8px 6px; /* Taller tap area */
        text-align: center;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-footer { display: none; }

      .billing-layout { 
        grid-template-columns: 1fr;
        position: relative;
      }
      
      /* Sticky Bill Total on Mobile */
      .billing-layout aside {
        position: sticky;
        bottom: 0;
        z-index: 20;
        /* The summary-box styles (background, border) handle the appearance */
      }
      
      .card { padding: 10px; }
      table th, table td { font-size: 11px; padding: 4px 6px; }
      .table-wrapper { max-height: 360px; }
      
      /* Bigger tap areas */
      .btn {
        padding: 10px 16px; 
      }
      .product-card {
        min-height: 160px; /* Taller card */
      }
      .form-grid.grid-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns on mobile */
      }
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns on mobile */
      }
    }

    @media (max-width: 640px) {
      header.page-header h1 { font-size: 18px; }
      .container { padding: 0 2px; }
      .product-card { width: 48%; max-width: 180px; } /* 2 columns */
      form.controls input,
      form.controls select { min-width: 100px; flex: 1 1 45%; }
      .trend-layout { flex-direction: column; }
      #revenue-trend { max-width: 100%; }
      .form-grid, .form-grid.grid-4 {
        grid-template-columns: 1fr; /* 1 column on smallest screens */
      }
      .customer-fields {
        width: 100%;
      }
      .customer-fields input {
        width: 100%;
        min-width: 0;
      }
      
      /* MOBILE CARD VIEW FOR BILLING TABLE */
      #view-billing table, 
      #view-billing thead, 
      #view-billing tbody, 
      #view-billing th, 
      #view-billing td, 
      #view-billing tr { 
        display: block; 
      }

      #view-billing thead tr { 
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      #view-billing tbody tr { 
        background: #1e293b; /* Darker card bg */
        border: 1px solid rgba(148,163,184,0.2);
        border-radius: 12px;
        margin-bottom: 10px;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      }

      #view-billing td { 
        border: none;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        position: relative;
        padding: 8px 0;
        padding-left: 35%; /* Make space for label */
        text-align: right;
        min-height: 30px;
      }

      #view-billing td::before { 
        content: attr(data-label);
        position: absolute;
        left: 0;
        top: 8px;
        width: 30%;
        font-size: 11px;
        color: #94a3b8; /* Muted text */
        font-weight: 700;
        text-transform: uppercase;
        text-align: left;
      }

      #view-billing td[data-label="Item"] {
        text-align: left; /* Name should be left aligned */
        padding-left: 0;
        font-size: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 4px;
        padding-bottom: 8px;
      }
      #view-billing td[data-label="Item"]::before {
        display: none; /* Hide the word "Item" */
      }

      #view-billing td.actions-cell {
        padding-left: 0;
        padding-bottom: 0;
        border-bottom: none;
        margin-top: 4px;
      }

      /* MOBILE CARD VIEW FOR REPORTS TABLE */
      #list-view table, 
      #list-view thead, 
      #list-view tbody, 
      #list-view th, 
      #list-view td, 
      #list-view tr { 
        display: block; 
      }

      #list-view thead tr { 
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      #list-view tr { 
        background: linear-gradient(180deg, rgba(15,23,42,0.95), #020617);
        border: 1px solid rgba(31,41,55,0.9);
        border-radius: 12px;
        margin-bottom: 12px;
        padding: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      }

      #list-view td { 
        border: none;
        border-bottom: 1px solid rgba(31,41,55,0.5); 
        position: relative;
        padding-left: 0;
        padding: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: right;
      }

      #list-view td:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      #list-view td::before { 
        content: attr(data-label);
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        text-align: left;
      }
      
      #list-view td.actions-cell {
        display: block;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px dashed rgba(31,41,55,0.8);
      }
      
      #list-view td.actions-cell::before { display: none; }
      
      #list-view td.actions-cell div {
        justify-content: space-between !important;
        width: 100%;
      }
      
      #list-view td.actions-cell button {
        flex: 1;
        text-align: center;
        padding: 8px;
      }
    }
  </style>
</head>
<body>

  <div id="offline-banner">You are currently offline.</div>
  <div id="toast" role="status" aria-live="polite"></div>

  <div id="app-shell">
    <div class="app-shell-inner">
      <nav class="left-nav" aria-label="Primary navigation">
        <div class="brand">
          <div class="logo">SP</div>
          <div class="brand-text">
            <span id="brand-shop-name">Sri Parvathi Oil Stores</span><br>
            <small id="brand-shop-address">Cuddalore</small>
          </div>
        </div>

        <ul class="nav-list">
          <li><a href="#inventory" data-view="inventory" id="nav-inventory" class="active">Inventory</a></li>
          <li><a href="#billing" data-view="billing" id="nav-billing">Billing</a></li>
          <li><a href="#purchases" data-view="purchases" id="nav-purchases">Purchases</a></li>
          <li><a href="#reports" data-view="reports" id="nav-reports">Reports</a></li>
        </ul>

        <div class="nav-footer">
          <div id="nav-footer-shop-line">Sri Parvathi Oil Stores, Cuddalore</div>
          <button id="reload-btn" class="btn btn-ghost" style="margin-top:8px;width:100%;justify-content:center;">
            Reload App
          </button>
        </div>
      </nav>

      <main>
        <div class="container">

          <section id="view-inventory">
            <header class="page-header">
              <div>
                <h1>Inventory</h1>
                <div class="muted">Add / edit products and manage stock</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button id="settings-btn" class="btn btn-secondary" type="button">Settings</button>
                <button id="export-data-btn" class="btn btn-primary" type="button">Backup</button>
                <label class="btn btn-ghost" style="padding-inline:10px;cursor:pointer;">
                  Import
                  <input id="import-file-input" type="file" accept="application/json" style="display:none">
                </label>
              </div>
            </header>

            <section class="card" style="margin-bottom:14px;">
              <h2 style="margin-top:0;font-size:16px;">Add / Edit Product</h2>
              <form id="inventory-form" class="inventory-form" autocomplete="off">
                <input id="product-edit-id" type="hidden" value="">
                
                <div class="form-grid grid-4">
                  <label>
                    <div class="label">Product name *</div>
                    <input id="product-name" type="text" required placeholder="e.g. Groundnut Oil">
                  </label>
                  <label>
                    <div class="label">Variant / Description</div>
                    <input id="product-variant" type="text" placeholder="e.g. 5L tin, Regular">
                  </label>
                  <label>
                    <div class="label">Category</div>
                    <input id="product-category" type="text" placeholder="e.g. Groundnut" list="category-suggestions">
                    <datalist id="category-suggestions"></datalist>
                  </label>
                  <label>
                    <div class="label">Image URL (optional)</div>
                    <input id="product-image-url" type="text" placeholder="http://...jpg">
                  </label>
                </div>
                
                <hr style="border:0; border-top:1px solid rgba(31,41,55,0.7); margin: 12px 0;">
                
                <div class="form-grid grid-4">
                  <label>
                    <div class="label">Base unit *</div>
                    <select id="product-unit">
                      <option value="unit">Unit (piece)</option>
                      <option value="L">Liters (L)</option>
                      <option value="ml">Milliliters (ml)</option>
                      <option value="kg">Kilograms (kg)</option>
                      <option value="g">Grams (g)</option>
                    </select>
                  </label>
                  <label>
                    <div class="label">Buy Price (per unit, ₹)</div>
                    <input id="product-buy-price" type="number" step="0.01" min="0" value="0">
                  </label>
                  <label>
                    <div class="label">Sell Price (per unit, ₹) *</div>
                    <input id="product-price" type="number" step="0.01" min="0" required>
                  </label>
                  <label>
                    <div class="label">Tax % (e.g. 5, 12)</div>
                    <input id="product-tax-percent" type="number" step="0.01" min="0" value="0">
                  </label>
                </div>
                
                <hr style="border:0; border-top:1px solid rgba(31,41,55,0.7); margin: 12px 0;">

                <div class="form-grid grid-4">
                  <label>
                    <div class="label">Current Stock *</div>
                    <input id="product-stock" type="number" step="0.001" min="0" required>
                  </label>
                  <label>
                    <div class="label">Reorder Level</div>
                    <input id="product-reorder-level" type="number" step="0.001" min="0" value="0" placeholder="Low stock warning">
                  </label>
                  <label>
                    <div class="label">Supplier Name</div>
                    <input id="product-supplier-name" type="text" placeholder="e.g. Main Supplier">
                  </label>
                  <label>
                    <div class="label">Last Purchase Date</div>
                    <input id="product-last-purchase-date" type="text" readonly placeholder="Auto-updated">
                  </label>
                </div>
                
                <hr style="border:0; border-top:1px solid rgba(31,41,55,0.7); margin: 12px 0;">
                
                <div class="form-grid grid-4">
                  <label style="grid-column: 1 / 3;">
                    <div class="label">Link to Raw Stock (Optional)</div>
                    <select id="product-links-to-id">
                      <option value="">None (This is a raw product)</option>
                      </select>
                  </label>
                  <label style="grid-column: 3 / 5;">
                    <div class="label">Conversion (e.g., 1 tin = 15 L)</div>
                    <input id="product-conversion-factor" type="number" step="0.001" min="0" placeholder="e.g. 15 (for 15L)">
                  </label>
                </div>


                <div style="margin-top:12px;display:flex;gap:8px;">
                  <button id="submit-form-btn" type="submit" class="btn btn-primary">Add Product</button>
                  <button id="cancel-edit-btn" type="button" class="btn btn-ghost hidden">Cancel</button>
                </div>
              </form>
            </section>

            <section class="card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px;flex-wrap:wrap;">
                <h2 style="margin:0;font-size:16px;">Inventory List</h2>
                
                <div class="controls">
                  <label class="text-xs">
                    Filter by Category
                    <select id="inventory-category-filter">
                      <option value="">All Categories</option>
                    </select>
                  </label>
                </div>
                
                <div class="muted text-sm">Total value: <strong id="total-inventory-value">₹0.00</strong></div>
              </div>

              <div class="table-wrapper">
                <table aria-describedby="Inventory list">
                  <thead>
                    <tr>
                      <th>Image</th>
                      <th>Product</th>
                      <th>Category</th>
                      <th>Buy</th>
                      <th>Sell</th>
                      <th>Stock</th>
                      <th>Supplier</th>
                      <th>Value</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="inventory-list"></tbody>
                </table>
              </div>
            </section>
          </section>

          <section id="view-billing" style="display:none;">
            <header class="page-header">
              <div>
                <h1>New Bill</h1>
                <div class="muted">Quick POS</div>
              </div>
            </header>

            <div class="card">
              <div class="top-row">
                <div class="customer-fields">
                  <input id="customer-name" placeholder="Customer name (optional)" list="customer-suggestions-name">
                  <input id="customer-phone" placeholder="Phone (10 digits)" type="tel" maxlength="10"
                         oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)" list="customer-suggestions-phone">
                  <datalist id="customer-suggestions-name"></datalist>
                  <datalist id="customer-suggestions-phone"></datalist>
                </div>
              </div>

              <div class="billing-layout" style="margin-top:10px;">
                <div>
                  <h3 style="margin:0 0 6px 0;font-size:14px;">1 • Select Product</h3>
                  
                  <div style="display:flex; gap:6px; margin-bottom: 8px;">
                    <select id="product-select-dropdown" style="width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(30,64,175,0.65); background: rgba(15,23,42,0.95); color: var(--text-on-bg); font-size: 14px; outline: none;">
                      <option value="">Select product from list...</option>
                    </select>
                    <button id="scan-barcode-btn" class="btn btn-info" type="button" title="Scan Barcode/QR">
                      Scan
                    </button>
                  </div>
                  
                  <div id="product-grid" class="product-grid" aria-live="polite"></div>

                  <h3 style="margin:10px 0 6px 0;font-size:14px;">2 • Add Details</h3>
                  <form id="billing-form" class="controls" aria-label="Add product to bill">
                    <input type="hidden" id="selected-product-id" value="">
                    <div style="min-width:180px;">
                      <div id="selected-product-name" class="muted">No product selected</div>
                      <div id="selected-product-price-info" class="muted text-xs"></div>
                    </div>
                    <input type="number" id="billing-quantity" min="0.001" step="0.001" placeholder="Qty">
                    <select id="billing-unit">
                      <option value="base">Base unit</option>
                    </select>
                    <input type="number" id="billing-price" step="0.01" min="0" placeholder="Rate (₹)" readonly>
                    <input type="number" id="billing-custom-price" step="0.01" min="0" placeholder="Custom Price (₹, optional)">
                    <button type="submit" class="btn btn-primary">Add item</button>
                  </form>

                  <h3 style="margin:12px 0 6px 0;font-size:14px;">3 • Items</h3>
                  <div class="table-wrapper" style="max-height:260px;">
                    <table>
                      <thead>
                        <tr>
                          <th>Item</th>
                          <th>Qty</th>
                          <th>Rate</th>
                          <th>Tax</th>
                          <th>Total</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="bill-items"></tbody>
                    </table>
                  </div>
                </div>

                <aside>
                  <div class="summary-box">
                    <div class="summary-line">
                      <span>Subtotal</span>
                      <span id="bill-subtotal">₹0.00</span>
                    </div>
                    <div class="summary-line tax-line">
                      <span>Total Tax</span>
                      <span id="bill-total-tax">₹0.00</span>
                    </div>
                    <div class="summary-line">
                      <span>Discount</span>
                      <span>
                        <input type="number" id="bill-discount" step="0.01" min="0" style="width:90px;text-align:right;" value="0">
                      </span>
                    </div>
                    <div class="summary-line big">
                      <span>Total</span>
                      <span id="bill-total">₹0.00</span>
                    </div>

                    <div class="pill-row">
                      <button id="clear-bill-btn" class="btn btn-ghost" type="button">Clear</button>
                      <button id="complete-sale-btn" class="btn btn-primary" type="button">Complete Sale</button>
                    </div>

                    <div class="muted text-xs" style="margin-top:6px;">
                      Complete sale will reduce stock from inventory and save bill into reports.
                    </div>
                  </div>
                </aside>
              </div>
            </div>
          </section>
          
          <section id="view-purchases" style="display:none;">
            <header class="page-header">
              <div>
                <h1>Purchases</h1>
                <div class="muted">Record purchase bills and update inventory</div>
              </div>
            </header>

            <section class="card" style="margin-bottom:14px;">
              <h2 style="margin-top:0;font-size:16px;">Add Purchase</h2>
              <form id="purchase-form" class="inventory-form" autocomplete="off">
                <div class="form-grid grid-4">
                  <label>
                    <div class="label">Date *</div>
                    <input id="purchase-date" type="date" required>
                  </label>
                  <label>
                    <div class="label">Supplier Name *</div>
                    <input id="purchase-supplier" type="text" required placeholder="Supplier Name">
                  </label>
                  <label style="grid-column: 3 / 5;">
                    <div class="label">Product *</div>
                    <select id="purchase-product-select" required>
                      <option value="">Select product to stock</option>
                      </select>
                  </label>
                  <label>
                    <div class="label">Quantity (in base unit) *</div>
                    <input id="purchase-quantity" type="number" step="0.001" min="0" required placeholder="e.g. 100">
                  </label>
                  <label>
                    <div class="label">Rate (Buy Price per unit) *</div>
                    <input id="purchase-rate" type="number" step="0.01" min="0" required placeholder="e.g. 150">
                  </label>
                </div>

                <div style="margin-top:12px;display:flex;gap:8px;">
                  <button type="submit" class="btn btn-primary">Add Purchase</button>
                </div>
              </form>
            </section>

            <section class="card">
              <h2 style="margin:0 0 8px 0;font-size:16px;">Recent Purchases</h2>
              <div class="table-wrapper">
                <table aria-describedby="Purchase history list">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Supplier</th>
                      <th>Product</th>
                      <th>Qty</th>
                      <th>Rate</th>
                      <th>Total</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="purchase-history-list"></tbody>
                </table>
              </div>
            </section>
          </section>


          <section id="view-reports" style="display:none;">
            <header class="page-header">
              <div>
                <h1>Reports</h1>
                <div class="muted text-sm">Day / range-wise sales, profit, GST, export &amp; print</div>
              </div>
            </header>

            <section class="card">
              <div class="controls" style="margin-bottom:8px;">
                <label class="text-xs">
                  Start
                  <input type="date" id="report-start-date">
                </label>
                <label class="text-xs">
                  End
                  <input type="date" id="report-end-date">
                </label>

                <label class="text-xs">
                  Item
                  <select id="report-item-select">
                    <option value="">All</option>
                  </select>
                </label>
                
                <label class="text-xs">
                  Customer
                  <input id="report-customer-search" type="text" placeholder="Name/Phone" list="customer-suggestions-name">
                </label>

                <button id="apply-date-range-btn" class="btn btn-primary" type="button">Apply</button>

                <div class="quick-presets">
                  <button class="btn btn-ghost" id="preset-today" type="button">Today</button>
                  <button class="btn btn-ghost" id="preset-7" type="button">Last 7</button>
                  <button class="btn btn-ghost" id="preset-30" type="button">Last 30</button>
                  <button class="btn btn-ghost" id="preset-month" type="button">This Month</button>
                </div>

                <label class="text-xs" style="display:flex;align-items:center;gap:4px;">
                  Export:
                  <select id="export-format">
                    <option value="json">JSON</option>
                    <option value="csv">CSV</option>
                    <option value="xlsx">Excel</option>
                  </select>
                </label>
                <button id="export-range-btn" class="btn btn-secondary" type="button">Export</button>

                <button id="print-report-btn" class="btn btn-print" type="button">Print Results</button>
              </div>

              <div class="trend-layout">
                <div style="flex:1;" class="card-subtle">
                  <div class="text-xs muted" style="margin-bottom:4px;">Revenue trend (per day)</div>
                  <canvas id="revenue-trend" height="80"></canvas>
                </div>
                <div style="width:220px;min-width:200px;" class="card-subtle">
                  <div class="text-xs muted" style="margin-bottom:4px;">Top Items (by Revenue)</div>
                  <div id="top-items-list"></div>
                </div>
              </div>
            </section>

            <section style="margin-top:10px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap;">
                <div class="tabs">
                  <button class="tab active" data-tab="list-view" type="button">Bills</button>
                  <button class="tab" data-tab="party-view" type="button">Party-wise</button>
                  <button class="tab" data-tab="profit-view" type="button">Profit Summary</button>
                  <button class="tab" data-tab="gst-view" type="button">GST Summary</button>
                  <button class="tab" data-tab="purchase-view" type="button">Purchase Report</button>
                </div>
                <div id="reports-summary" class="text-xs muted"></div>
              </div>

              <section id="list-view" class="report-panel card" style="margin-bottom:10px;">
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Bill No</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Profit (Est.)</th>
                        <th>Total</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="reports-list"></tbody>
                  </table>
                </div>
              </section>

              <section id="party-view" class="report-panel card" style="display:none;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                  <h3 style="margin:0;font-size:14px;">Party-wise Summary (by Revenue)</h3>
                  <button id="show-party-wise-btn" class="btn btn-primary" type="button">Refresh</button>
                </div>
                <div id="party-wise-container"></div>
                <p class="muted text-xs" style="margin-top:8px;">Click a party row to filter Bills tab by that customer.</p>
              </section>
              
              <section id="profit-view" class="report-panel card" style="display:none;">
                <h3 style="margin:0 0 8px 0;font-size:14px;">Profit Summary (Estimated)</h3>
                <div class="trend-layout">
                  <div style="flex:1;" class="card-subtle">
                    <div class="text-xs muted" style="margin-bottom:4px;">Top Items (by Profit)</div>
                    <div id="top-profit-items-list" style="max-height: 300px; overflow-y: auto;"></div>
                  </div>
                  <div style="flex:1;" class="card-subtle">
                    <div class="text-xs muted" style="margin-bottom:4px;">Top Customers (by Profit)</div>
                    <div id="top-profit-customers-list" style="max-height: 300px; overflow-y: auto;"></div>
                  </div>
                </div>
              </section>
              
              <section id="gst-view" class="report-panel card" style="display:none;">
                <h3 style="margin:0 0 8px 0;font-size:14px;">GST Summary</h3>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Tax Rate (%)</th>
                        <th>Taxable Value (₹)</th>
                        <th>Tax Amount (₹)</th>
                      </tr>
                    </thead>
                    <tbody id="gst-summary-list"></tbody>
                  </table>
                </div>
              </section>
              
              <section id="purchase-view" class="report-panel card" style="display:none;">
                <h3 style="margin:0 0 8px 0;font-size:14px;">Purchase Report</h3>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Supplier</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Rate</th>
                        <th>Total</th>
                      </tr>
                    </thead>
                    <tbody id="purchase-report-list"></tbody>
                  </table>
                </div>
              </section>

            </section>
          </section>
        </div>
      </main>
    </div>
  </div>

  <div id="print-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="print-modal-title">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-panel" role="document" aria-modal="true">
      <header class="modal-header">
        <h3 id="print-modal-title">Sale Completed</h3>
        <button class="modal-close" id="print-modal-close" aria-label="Close">&times;</button>
      </header>
      <div class="modal-body">
        <p id="print-modal-text">The sale was saved successfully. What would you like to do?</p>
        <div class="modal-meta" id="print-modal-meta"></div>
        
        <!-- NEW UPI SECTION -->
        <div id="upi-section">
            <div class="text-xs muted" style="margin-bottom:6px;">UPI QR Code (Scan to Pay)</div>
            <canvas id="upi-qr-canvas"></canvas>
            <div id="upi-status-text" class="text-xs" style="color:var(--success);"></div>
        </div>
        
      </div>
        <footer class="modal-footer">
         <button id="modal-print-now" class="btn-print" type="button">Print </button>
         <button id="modal-whatsapp" class="btn btn-secondary" type="button">Send to WhatsApp</button>
         <button id="modal-show-upi" class="btn btn-primary" type="button" style="background: linear-gradient(90deg, #10b981, #059669);">Show QR</button>
         <button id="modal-skip" class="btn btn-ghost" type="button">Skip</button>
      </footer>

    </div>
  </div>

    <div id="whatsapp-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="whatsapp-modal-title">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-panel" role="document" aria-modal="true">
      <header class="modal-header">
        <h3 id="whatsapp-modal-title">Send Invoice via WhatsApp</h3>
        <button class="modal-close" id="whatsapp-close-btn" aria-label="Close">&times;</button>
      </header>
      <div class="modal-body">
        <label class="text-xs">
          WhatsApp Number
          <input type="tel" id="whatsapp-number" placeholder="Enter phone number">
        </label>
        <p class="muted text-xs" style="margin-top:6px;">
          We’ll open WhatsApp with this number. You can review and send the message there.
        </p>
      </div>
      <footer class="modal-footer">
        <button id="whatsapp-cancel" class="btn btn-ghost" type="button">Cancel</button>
        <button id="whatsapp-send" class="btn btn-primary" type="button">Send</button>
      </footer>
    </div>
  </div>


  <div id="settings-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="settings-modal-title">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-panel" role="document" aria-modal="true">
      <header class="modal-header">
        <h3 id="settings-modal-title">Shop Settings</h3>
        <button class="modal-close" id="settings-close-btn" aria-label="Close">&times;</button>
      </header>
      <div class="modal-body">
        <label class="text-xs">
          Shop Name
          <input type="text" id="settings-shop-name" placeholder="Sri Parvathi Oil Stores">
        </label>
        <label class="text-xs" style="margin-top:8px;">
          Address / Location
          <input type="text" id="settings-shop-address" placeholder="Cuddalore">
        </label>
        <label class="text-xs" style="margin-top:8px;">
          GST Number (optional)
          <input type="text" id="settings-shop-gst" placeholder="GSTIN">
        </label>
        
        <!-- UPI SETTINGS -->
        <label class="text-xs" style="margin-top:12px; display:block; padding-top:12px; border-top:1px solid #334155;">
          UPI ID (VPA) for Payments
          <input type="text" id="settings-upi-id" placeholder="e.g. mobile@upi or name@okhdfcbank">
        </label>
         <label class="text-xs" style="margin-top:8px;">
          Payee Name (for UPI)
          <input type="text" id="settings-payee-name" placeholder="e.g. Sri Parvathi Oils">
        </label>
        
      </div>
      <footer class="modal-footer">
        <button id="settings-cancel" class="btn btn-ghost" type="button">Cancel</button>
        <button id="settings-save" class="btn btn-primary" type="button">Save</button>
      </footer>
    </div>
  </div>
  
  <!-- PRODUCT LABEL MODAL -->
  <div id="label-modal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-panel" role="document" style="text-align:center;">
      <header class="modal-header">
        <h3>Product Label</h3>
        <button class="modal-close" id="label-close-btn">&times;</button>
      </header>
      <div class="modal-body" id="label-print-area" style="background:white; padding:10px; color:black; border-radius:8px;">
        <div style="border:2px solid black; padding:8px; display:inline-block; min-width:160px;">
            <h4 id="label-product-name" style="margin:0; font-size:14px;">Product Name</h4>
            <div id="label-product-variant" style="font-size:12px; margin-bottom:4px;">Variant</div>
            <canvas id="label-qr-canvas"></canvas>
            <div id="label-product-price" style="font-weight:bold; margin-top:4px;">₹0.00</div>
        </div>
      </div>
      <footer class="modal-footer">
         <button id="label-print-btn" class="btn btn-print" type="button">Print Label</button>
      </footer>
    </div>
  </div>
  
  <!-- SCANNER MODAL -->
  <div id="scanner-modal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-panel" role="document" style="max-width:500px;">
      <header class="modal-header">
        <h3>Scan Product QR</h3>
        <button class="modal-close" id="scanner-close-btn">&times;</button>
      </header>
      <div class="modal-body">
        <div id="scanner-preview"></div>
        <p class="text-xs muted" style="text-align:center;">Point camera at the product label code.</p>
      </div>
    </div>
  </div>

  <div id="invoice-to-print" style="display:none">
    <div id="receipt-header" style="text-align:center;">
      <h2 style="margin:0"><span id="header-shop-name">Sri Parvathi Oil Stores</span></h2>
      <p style="margin:0"><span id="header-shop-address">Cuddalore</span></p>
      <p id="invoice-gst" style="margin:0;font-size:12px;"></p>
      <p id="invoice-date" style="margin:0;font-size:12px;"></p>
      <p id="invoice-bill-no" style="margin:0;font-size:12px;"></p>
      <p id="invoice-customer" style="margin:0;font-size:12px;"></p>
    </div>

    <hr>

    <table id="receipt-items-table" style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr>
          <th style="text-align:left;">Item</th>
          <th style="text-align:right;">Qty</th>
          <th style="text-align:left;">Rate</th>
          <th style="text-align:right;">Tax</th>
          <th style="text-align:right;">Total</th>
        </tr>
      </thead>

      <tbody id="invoice-items"></tbody>
    </table>

    <hr>

    <table id="receipt-totals-table" style="width:100%;font-size:12px;">
      <tbody>
        <tr><td>Subtotal</td><td id="invoice-subtotal" style="text-align:right;"></td></tr>
        <tr><td>Tax</td><td id="invoice-tax" style="text-align:right;"></td></tr>
        <tr><td>Discount</td><td id="invoice-discount" style="text-align:right;"></td></tr>
        <tr><td><strong>Total</strong></td><td id="invoice-total" style="text-align:right;"></td></tr>
      </tbody>
    </table>

    <hr>

    <div id="receipt-footer" style="text-align:center;font-size:12px;">
      <p style="margin:0;">Thank You! Visit Again!</p>
    </div>
  </div>

  <script>
    (function() {
      /* -------------------------------------------
         HELPERS
         ------------------------------------------- */
      function fmt(num) {
        const n = Number(num) || 0;
        return n.toFixed(2);
      }
      
      function fmtQty(num) {
         const n = Number(num) || 0;
         // Show decimals only if needed, up to 3 places
         return Number(n.toFixed(3));
      }

            // Toast + soft ding sound
      const toastEl = document.getElementById('toast');
      let toastTimeoutId = null;

      function playToastSound() {
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return;
          const ctx = new AudioCtx();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.type = 'sine';
          osc.frequency.value = 880; // ding tone
          gain.gain.value = 0.08;    // soft volume

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.start();
          osc.stop(ctx.currentTime + 0.15);
          osc.onended = () => ctx.close();
        } catch (e) {
          // Fail silently if audio not supported
        }
      }

      function showToast(message) {
        if (!toastEl) return;
        toastEl.textContent = message;

        // restart animation
        toastEl.classList.remove('visible');
        void toastEl.offsetWidth; // force reflow
        toastEl.classList.add('visible');

        playToastSound();

        if (toastTimeoutId) clearTimeout(toastTimeoutId);
        toastTimeoutId = setTimeout(() => {
          toastEl.classList.remove('visible');
        }, 2500);
      }


      function load(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return fallback;
          return JSON.parse(raw);
        } catch (e) {
          console.warn('load error', key, e);
          return fallback;
        }
      }

      function save(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.warn('save error', key, e);
        }
      }

      function getInventory() { return load('sp_inventory', []); }
      function saveInventory(inv) { save('sp_inventory', inv); }

      function getSales() { return load('sp_sales', []); }
      function saveSales(sales) { save('sp_sales', sales); }
      
      function getPurchases() { return load('sp_purchases', []); }
      function savePurchases(purchases) { save('sp_purchases', purchases); }
      
      function getCustomers() { return load('sp_customers', []); }
      function saveCustomers(customers) { save('sp_customers', customers); }

      function getNextBillNo() {
        const n = load('sp_nextBillNo', 1);
        save('sp_nextBillNo', n + 1);
        return n;
      }

      function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // Local date (YYYY-MM-DD) for correct filtering in India time
      function toLocalYMD(dateLike) {
        if (!dateLike) return null;
        try {
          const d = new Date(dateLike);
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${y}-${m}-${day}`;
        } catch (e) {
          return null;
        }
      }
      
      // Format date for input[type=date]
      function fmtDateInput(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      };

      // Shop settings
      function getShopSettings() {
        return load('sp_shopSettings', {
          name: 'Sri Parvathi Oil Stores',
          address: 'Cuddalore',
          gst: '',
          upiId: '',
          payeeName: ''
        });
      }
      function saveShopSettings(s) { save('sp_shopSettings', s); }

      function updateShopUI() {
        const s = getShopSettings();
        const brandNameEl = document.getElementById('brand-shop-name');
        const brandAddrEl = document.getElementById('brand-shop-address');
        const navFooterLine = document.getElementById('nav-footer-shop-line');
        if (brandNameEl) brandNameEl.textContent = s.name || 'Shop Name';
        if (brandAddrEl) brandAddrEl.textContent = s.address || '';
        if (navFooterLine) navFooterLine.textContent = s.name + (s.address ? ', ' + s.address : '');
      }

      /* -------------------------------------------
         NAVIGATION VIEW SWITCH
         ------------------------------------------- */
      const navLinks = document.querySelectorAll('.nav-list a[data-view]');
      const viewInventory = document.getElementById('view-inventory');
      const viewBilling = document.getElementById('view-billing');
      const viewPurchases = document.getElementById('view-purchases');
      const viewReports = document.getElementById('view-reports');
      const views = { 
        inventory: viewInventory, 
        billing: viewBilling, 
        purchases: viewPurchases,
        reports: viewReports 
      };

      function setActiveView(name) {
        Object.keys(views).forEach(v => {
          if (views[v]) {
            views[v].style.display = (v === name) ? '' : 'none';
          }
        });
        navLinks.forEach(a => {
          a.classList.toggle('active', a.dataset.view === name);
        });
        if (location.hash !== '#' + name) {
          history.replaceState(null, '', '#' + name);
        }
        
        // Refresh data on view change
        if (name === 'reports') {
          populateReportSelectors();
          applyAndRenderReports();
        }
        if (name === 'billing') {
          renderProductGrid();
          populateCustomerDatalists();
          populateProductSelectDropdown(); // NEW
        }
        if (name === 'inventory') {
          displayInventory(); // Refresh inventory list
          updateLinkedProductOptions(); // Refresh dropdowns
        }
        if (name === 'purchases') {
          updateLinkedProductOptions(); // Refresh product dropdown
          displayPurchases();
          document.getElementById('purchase-date').value = fmtDateInput(new Date());
        }
      }

      navLinks.forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const view = a.dataset.view;
          setActiveView(view);
        });
      });

      function initFromHash() {
        const h = (location.hash || '').replace('#', '');
        if (h && views[h]) {
          setActiveView(h);
        } else {
          setActiveView('inventory');
        }
      }

      const reloadBtn = document.getElementById('reload-btn');
      if (reloadBtn) {
        reloadBtn.addEventListener('click', () => location.reload());
      }
      
      /* -------------------------------------------
         OFFLINE/ONLINE STATUS
         ------------------------------------------- */
       const offlineBanner = document.getElementById('offline-banner');
       function updateOnlineStatus() {
         if (navigator.onLine) {
           offlineBanner.classList.remove('visible');
         } else {
           offlineBanner.classList.add('visible');
         }
       }
       window.addEventListener('online', updateOnlineStatus);
       window.addEventListener('offline', updateOnlineStatus);
       updateOnlineStatus(); // Initial check


      /* -------------------------------------------
         INVENTORY PAGE LOGIC
         ------------------------------------------- */
      const inventoryForm = document.getElementById('inventory-form');
      const inventoryList = document.getElementById('inventory-list');
      const submitBtn = document.getElementById('submit-form-btn');
      const cancelBtn = document.getElementById('cancel-edit-btn');
      const editIdInput = document.getElementById('product-edit-id');
      const exportBtn = document.getElementById('export-data-btn');
      const importInput = document.getElementById('import-file-input');
      
      // New Form Fields
      const categoryInput = document.getElementById('product-category');
      const categoryDatalist = document.getElementById('category-suggestions');
      const reorderLevelInput = document.getElementById('product-reorder-level');
      const supplierNameInput = document.getElementById('product-supplier-name');
      const lastPurchaseDateInput = document.getElementById('product-last-purchase-date');
      const taxPercentInput = document.getElementById('product-tax-percent');
      const linksToIdInput = document.getElementById('product-links-to-id');
      const conversionFactorInput = document.getElementById('product-conversion-factor');
      
      const imageUrlInput = document.getElementById('product-image-url');
      const buyPriceInput = document.getElementById('product-buy-price');
      const categoryFilter = document.getElementById('inventory-category-filter');

      function resetInventoryForm() {
        inventoryForm.reset();
        editIdInput.value = '';
        submitBtn.textContent = 'Add Product';
        cancelBtn.classList.add('hidden');
      }
      
      // Populate dropdowns that list all products
      function updateLinkedProductOptions() {
        const inv = getInventory();
        const currentEditId = editIdInput.value;
        
        const purchaseProductSelect = document.getElementById('purchase-product-select');
        
        linksToIdInput.innerHTML = '<option value="">None (This is a raw product)</option>';
        purchaseProductSelect.innerHTML = '<option value="">Select product to stock</option>';
        
        inv.forEach(item => {
          // Can't link a product to itself
          if (String(item.id) !== String(currentEditId)) {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = `${item.name} (${item.variant || item.unit})`;
            linksToIdInput.appendChild(opt);
          }
          
          const pOpt = document.createElement('option');
          pOpt.value = item.id;
          pOpt.textContent = `${item.name} (${item.variant || item.unit})`;
          purchaseProductSelect.appendChild(pOpt.cloneNode(true));
        });
      }

      function displayInventory() {
        const inv = getInventory();
        if (!inventoryList) return;
        inventoryList.innerHTML = '';
        let totalInventoryValue = 0;
        
        const categories = new Set();
        inv.forEach(item => {
          if (item.category) categories.add(item.category);
        });
        
        // Populate category filter
        const currentCatFilterVal = categoryFilter.value;
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          categoryFilter.appendChild(opt);
        });
        categoryFilter.value = currentCatFilterVal;
        
        // Populate category datalist
        categoryDatalist.innerHTML = '';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          categoryDatalist.appendChild(opt);
        });
        
        const filteredInv = inv.filter(item => {
          if (!currentCatFilterVal) return true; // "All Categories"
          return item.category === currentCatFilterVal;
        });

        filteredInv.forEach(item => {
          const itemValue = (Number(item.pricePerUnit) || 0) * (Number(item.stock) || 0);
          totalInventoryValue += itemValue;
          
          let stockHtml = `${fmtQty(item.stock || 0)} ${escapeHtml(item.unit || '')}`;
          const stock = Number(item.stock) || 0;
          const reorderLevel = Number(item.reorderLevel) || 0;
          
          if (stock === 0) {
            stockHtml += ` <span class="badge-pill badge-out-of-stock">Out of stock</span>`;
          } else if (reorderLevel > 0 && stock <= reorderLevel) {
            stockHtml += ` <span class="badge-pill badge-low-stock">Low stock</span>`;
          }
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><img src="${escapeHtml(item.imageUrl || '')}" class="inventory-thumb" onerror="this.style.display='none'"></td>
            <td>${escapeHtml(item.name)} ${escapeHtml(item.variant ? '('+item.variant+')' : '')}</td>
            <td>${escapeHtml(item.category || 'N/A')}</td>
            <td>₹${fmt(item.buyPrice || 0)} / ${escapeHtml(item.unit || '')}</td>
            <td>₹${fmt(item.pricePerUnit || 0)} / ${escapeHtml(item.unit || '')}</td>
            <td>${stockHtml}</td>
            <td>${escapeHtml(item.supplierName || 'N/A')}</td>
            <td><strong>₹${fmt(itemValue)}</strong></td>
            <td class="actions">
              <button class="btn-small label-btn" data-id="${item.id}" title="Generate Label">Label</button>
              <button class="btn-small edit" data-id="${item.id}">Edit</button>
              <button class="btn-small delete" data-id="${item.id}">Delete</button>
            </td>
          `;
          inventoryList.appendChild(row);
        });

        const totalValueCell = document.getElementById('total-inventory-value');
        if (totalValueCell) totalValueCell.textContent = `₹${fmt(totalInventoryValue)}`;
      }
      
      if (categoryFilter) {
        categoryFilter.addEventListener('change', displayInventory);
      }

      if (inventoryForm) {
        inventoryForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const inv = getInventory();
          const editId = editIdInput.value;
          const productData = {
            name: document.getElementById('product-name').value.trim(),
            variant: document.getElementById('product-variant').value.trim(),
            imageUrl: imageUrlInput.value.trim(),
            unit: document.getElementById('product-unit').value,
            buyPrice: Number(buyPriceInput.value) || 0,
            pricePerUnit: Number(document.getElementById('product-price').value) || 0,
            stock: Number(document.getElementById('product-stock').value) || 0,
            // New fields
            category: categoryInput.value.trim(),
            reorderLevel: Number(reorderLevelInput.value) || 0,
            supplierName: supplierNameInput.value.trim(),
            lastPurchaseDate: lastPurchaseDateInput.value, // Keep existing if editing
            taxPercent: Number(taxPercentInput.value) || 0,
            linksToProductId: linksToIdInput.value || null,
            conversionFactor: Number(conversionFactorInput.value) || 0
          };

          if (!productData.name) {
            alert('Product name is required.');
            return;
          }

          if (editId) {
            const index = inv.findIndex(i => String(i.id) === String(editId));
            if (index !== -1) {
              // Preserve last purchase date if not explicitly changed
              productData.lastPurchaseDate = productData.lastPurchaseDate || inv[index].lastPurchaseDate;
              inv[index] = Object.assign({}, inv[index], productData);
            }
          } else {
            productData.id = Date.now();
            inv.push(productData);
          }
          saveInventory(inv);
          resetInventoryForm();
          displayInventory();
          renderProductGrid();
          populateReportSelectors();
          updateLinkedProductOptions();
          populateProductSelectDropdown(); // NEW
        });
      }

      if (inventoryList) {
        inventoryList.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          if (!id) return;
          const inv = getInventory();
          if (e.target.classList.contains('delete')) {
            if (confirm('Are you sure you want to delete this product?')) {
              const newInv = inv.filter(i => String(i.id) !== String(id));
              saveInventory(newInv);
              displayInventory();
              renderProductGrid();
              populateReportSelectors();
              updateLinkedProductOptions();
              populateProductSelectDropdown(); // NEW
            }
          }
          if (e.target.classList.contains('edit')) {
            const item = inv.find(i => String(i.id) === String(id));
            if (!item) return;
            
            // Populate all fields
            document.getElementById('product-name').value = item.name;
            document.getElementById('product-variant').value = item.variant || '';
            imageUrlInput.value = item.imageUrl || '';
            document.getElementById('product-unit').value = item.unit || 'unit';
            buyPriceInput.value = item.buyPrice || 0;
            document.getElementById('product-price').value = item.pricePerUnit || 0;
            document.getElementById('product-stock').value = item.stock || 0;
            
            categoryInput.value = item.category || '';
            reorderLevelInput.value = item.reorderLevel || 0;
            supplierNameInput.value = item.supplierName || '';
            lastPurchaseDateInput.value = item.lastPurchaseDate || '';
            taxPercentInput.value = item.taxPercent || 0;
            
            editIdInput.value = item.id;
            
            // Refresh product link dropdown *before* setting its value
            updateLinkedProductOptions();
            linksToIdInput.value = item.linksToProductId || '';
            conversionFactorInput.value = item.conversionFactor || 0;
            
            submitBtn.textContent = 'Update Product';
            cancelBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
          
          // LABEL GENERATION
          if (e.target.classList.contains('label-btn')) {
              const item = inv.find(i => String(i.id) === String(id));
              if(item) openLabelModal(item);
          }
          
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', resetInventoryForm);
      }

      const exportBtnEl = exportBtn;
      if (exportBtnEl) {
        exportBtnEl.addEventListener('click', () => {
          const backupData = {
            inventory: getInventory(),
            sales: getSales(),
            purchases: getPurchases(),
            customers: getCustomers(),
            nextBillNo: load('sp_nextBillNo', 1),
            shopSettings: getShopSettings()
          };
          const jsonString = JSON.stringify(backupData, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'oilapp_backup.json';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }

      if (importInput) {
        importInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const data = JSON.parse(ev.target.result);
              const inv = Array.isArray(data.inventory) ? data.inventory : [];
              const sales = Array.isArray(data.sales) ? data.sales : [];
              const purchases = Array.isArray(data.purchases) ? data.purchases : [];
              const customers = Array.isArray(data.customers) ? data.customers : [];
              const nextBillNo = data.nextBillNo || 1;
              const shopSettings = data.shopSettings || getShopSettings();
              if (!confirm('This will overwrite existing data. Continue?')) return;
              saveInventory(inv);
              saveSales(sales);
              savePurchases(purchases);
              saveCustomers(customers);
              save('sp_nextBillNo', nextBillNo);
              saveShopSettings(shopSettings);
              alert('Import successful. Reloading page.');
              location.reload();
            } catch (err) {
              alert('Error reading file: ' + err.message);
            } finally {
              importInput.value = null;
            }
          };
          reader.readAsText(file);
        });
      }

      /* -------------------------------------------
         SETTINGS MODAL LOGIC
         ------------------------------------------- */
      const settingsBtn = document.getElementById('settings-btn');
      const settingsModal = document.getElementById('settings-modal');
      const settingsCloseBtn = document.getElementById('settings-close-btn');
      const settingsCancelBtn = document.getElementById('settings-cancel');
      const settingsSaveBtn = document.getElementById('settings-save');
      const settingsShopNameInput = document.getElementById('settings-shop-name');
      const settingsShopAddressInput = document.getElementById('settings-shop-address');
      const settingsShopGstInput = document.getElementById('settings-shop-gst');
      // NEW UPI INPUTS
      const settingsUpiIdInput = document.getElementById('settings-upi-id');
      const settingsPayeeNameInput = document.getElementById('settings-payee-name');

      function openSettingsModal() {
        const s = getShopSettings();
        settingsShopNameInput.value = s.name || '';
        settingsShopAddressInput.value = s.address || '';
        settingsShopGstInput.value = s.gst || '';
        settingsUpiIdInput.value = s.upiId || '';
        settingsPayeeNameInput.value = s.payeeName || '';
        settingsModal.classList.add('open');
      }
      function closeSettingsModal() {
        settingsModal.classList.remove('open');
      }

      if (settingsBtn) settingsBtn.addEventListener('click', openSettingsModal);
      if (settingsCloseBtn) settingsCloseBtn.addEventListener('click', closeSettingsModal);
      if (settingsCancelBtn) settingsCancelBtn.addEventListener('click', closeSettingsModal);
      if (settingsModal) {
        const backdrop = settingsModal.querySelector('.modal-backdrop');
        if (backdrop) backdrop.addEventListener('click', closeSettingsModal);
      }
      if (settingsSaveBtn) {
        settingsSaveBtn.addEventListener('click', () => {
          const s = {
            name: settingsShopNameInput.value.trim() || 'Shop',
            address: settingsShopAddressInput.value.trim(),
            gst: settingsShopGstInput.value.trim(),
            upiId: settingsUpiIdInput.value.trim(),
            payeeName: settingsPayeeNameInput.value.trim()
          };
          saveShopSettings(s);
          updateShopUI();
          alert('Settings saved.');
          closeSettingsModal();
        });
      }

      /* -------------------------------------------
         PURCHASES PAGE LOGIC (NEW)
         ------------------------------------------- */
      const purchaseForm = document.getElementById('purchase-form');
      const purchaseHistoryList = document.getElementById('purchase-history-list');

      function displayPurchases() {
        const purchases = getPurchases();
        purchaseHistoryList.innerHTML = '';
        purchases.slice().reverse().forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHtml(toLocalYMD(p.date))}</td>
            <td>${escapeHtml(p.supplierName)}</td>
            <td>${escapeHtml(p.productName)}</td>
            <td>${fmtQty(p.quantity)}</td>
            <td>₹${fmt(p.rate)}</td>
            <td>₹${fmt(p.total)}</td>
            <td><button class="btn-small delete" data-id="${p.id}">Delete</button></td>
          `;
          purchaseHistoryList.appendChild(row);
        });
      }

      if (purchaseForm) {
        purchaseForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const inv = getInventory();
          const productId = document.getElementById('purchase-product-select').value;
          const product = inv.find(i => String(i.id) === String(productId));
          if (!product) {
            alert('Please select a valid product.');
            return;
          }
          
          const purchaseDate = document.getElementById('purchase-date').value;
          const supplierName = document.getElementById('purchase-supplier').value.trim();
          const quantity = Number(document.getElementById('purchase-quantity').value);
          const rate = Number(document.getElementById('purchase-rate').value);
          
          if (!purchaseDate || !supplierName || quantity <= 0 || rate <= 0) {
            alert('Please fill all fields with valid values.');
            return;
          }

          // 1. Update Inventory
          product.stock = (Number(product.stock) || 0) + quantity;
          product.buyPrice = rate; // Update buy price to the latest rate
          product.lastPurchaseDate = purchaseDate;
          product.supplierName = supplierName;
          saveInventory(inv);

          // 2. Save Purchase Record
          const purchase = {
            id: Date.now(),
            date: new Date(purchaseDate).toISOString(),
            supplierName,
            productId,
            productName: `${product.name} (${product.variant || product.unit})`,
            quantity,
            rate,
            total: quantity * rate
          };
          const purchases = getPurchases();
          purchases.push(purchase);
          savePurchases(purchases);
          
          // 3. Reset and Refresh
          purchaseForm.reset();
          document.getElementById('purchase-date').value = fmtDateInput(new Date());
          displayPurchases();
          
          // Refresh other views
          displayInventory();
          renderProductGrid();
          populateProductSelectDropdown(); // NEW
          
          alert('Purchase recorded and stock updated.');
        });
      }
      
      if (purchaseHistoryList) {
        purchaseHistoryList.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          if (!id || !e.target.classList.contains('delete')) return;
          
          if (!confirm('Delete this purchase? This will also reduce the stock that was added.')) {
            return;
          }
          
          const purchases = getPurchases();
          const purchase = purchases.find(p => String(p.id) === String(id));
          if (!purchase) return;
          
          // 1. Restore Stock
          const inv = getInventory();
          const product = inv.find(i => String(i.id) === String(purchase.productId));
          if (product) {
            product.stock = (Number(product.stock) || 0) - (Number(purchase.quantity) || 0);
            if (product.stock < 0) product.stock = 0;
            saveInventory(inv);
          }
          
          // 2. Delete Purchase Record
          const newPurchases = purchases.filter(p => String(p.id) !== String(id));
          savePurchases(newPurchases);
          
          // 3. Refresh
          displayPurchases();
          displayInventory();
          renderProductGrid();
          populateProductSelectDropdown(); // NEW
        });
      }


      /* -------------------------------------------
         BILLING PAGE LOGIC
         ------------------------------------------- */
      const productGrid = document.getElementById('product-grid');
      const billingForm = document.getElementById('billing-form');
      const selectedProductIdInput = document.getElementById('selected-product-id');
      const selectedProductName = document.getElementById('selected-product-name');
      const selectedProductPriceInfo = document.getElementById('selected-product-price-info');
      const billingQuantityInput = document.getElementById('billing-quantity');
      const billingUnitSelect = document.getElementById('billing-unit');
      const billingPriceInput = document.getElementById('billing-price');
      const billingCustomPriceInput = document.getElementById('billing-custom-price');
      const billItemsList = document.getElementById('bill-items');
      const billSubtotalEl = document.getElementById('bill-subtotal');
      const billTotalTaxEl = document.getElementById('bill-total-tax');
      const billDiscountEl = document.getElementById('bill-discount');
      const billTotalEl = document.getElementById('bill-total');
      const completeSaleBtn = document.getElementById('complete-sale-btn');
      const clearBillBtn = document.getElementById('clear-bill-btn');
      const customerNameInput = document.getElementById('customer-name');
      const customerPhoneInput = document.getElementById('customer-phone');
      const customerDatalistName = document.getElementById('customer-suggestions-name');
      const customerDatalistPhone = document.getElementById('customer-suggestions-phone');
      
      // NEW: Dropdown element
      const productSelectDropdown = document.getElementById('product-select-dropdown');
      // NEW: Scanner btn
      const scanBarcodeBtn = document.getElementById('scan-barcode-btn');

      let currentBillItems = [];
      
      // Customer Autofill
      function saveCustomer(name, phone) {
        if (!name && !phone) return;
        const customers = getCustomers();
        const key = phone || name;
        const existing = customers.find(c => (c.phone === phone && phone) || c.name === name);
        if (!existing) {
          customers.push({ name, phone });
          saveCustomers(customers);
        } else if (existing && !existing.phone && phone) {
           existing.phone = phone; // Update name-only entry with phone
           saveCustomers(customers);
        } else if (existing && !existing.name && name) {
           existing.name = name; // Update phone-only entry with name
           saveCustomers(customers);
        }
      }
      
      function populateCustomerDatalists() {
        const customers = getCustomers();
        customerDatalistName.innerHTML = '';
        customerDatalistPhone.innerHTML = '';
        customers.forEach(c => {
          if (c.name) {
            const opt = document.createElement('option');
            opt.value = c.name;
            customerDatalistName.appendChild(opt);
          }
          if (c.phone) {
            const opt = document.createElement('option');
            opt.value = c.phone;
            customerDatalistPhone.appendChild(opt);
          }
        });
      }
      
      // When user selects a name, fill the phone (and vice-versa)
      customerNameInput.addEventListener('input', (e) => {
        const name = e.target.value;
        const customer = getCustomers().find(c => c.name === name && c.phone);
        if (customer) customerPhoneInput.value = customer.phone;
      });
      customerPhoneInput.addEventListener('input', (e) => {
        const phone = e.target.value;
        const customer = getCustomers().find(c => c.phone === phone && c.name);
        if (customer) customerNameInput.value = customer.name;
      });
      

      function renderProductGrid() {
        if (!productGrid) return;
        const inv = getInventory();
        productGrid.innerHTML = '';
        if (!inv.length) {
          productGrid.innerHTML = '<div class="muted text-xs">No products in inventory. Add products in Inventory tab.</div>';
          return;
        }

        inv.forEach(item => {
          const card = document.createElement('div');
          card.className = 'product-card';
          card.dataset.id = item.id;
          
          let badgeHtml = '';
          const stock = Number(item.stock) || 0;
          const reorderLevel = Number(item.reorderLevel) || 0;
          if (stock === 0) {
            badgeHtml = `<span class="badge-pill badge-out-of-stock stock-badge-corner">Out</span>`;
          } else if (reorderLevel > 0 && stock <= reorderLevel) {
            badgeHtml = `<span class="badge-pill badge-low-stock stock-badge-corner">Low</span>`;
          }
          
          card.innerHTML = `
            ${badgeHtml}
            <img src="${escapeHtml(item.imageUrl || '')}" onerror="this.style.display='none'">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="meta">${escapeHtml(item.variant || '')}</div>
            <div class="meta">₹${fmt(item.pricePerUnit || 0)} / ${escapeHtml(item.unit || '')}</div>
            <div class="badge-pill">${fmtQty(item.stock || 0)} ${escapeHtml(item.unit || '')} in stock</div>
          `;
          card.addEventListener('click', () => {
            document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectProductForBilling(item);
          });
          productGrid.appendChild(card);
        });
      }

      function selectProductForBilling(item) {
        selectedProductIdInput.value = item.id;
        selectedProductName.textContent = item.name;
        selectedProductPriceInfo.textContent = `₹${fmt(item.pricePerUnit || 0)} per ${item.unit}, stock: ${fmtQty(item.stock || 0)} ${item.unit}`;
        // default Qty = 1
        billingQuantityInput.value = 1;
        billingPriceInput.value = item.pricePerUnit || 0;
        billingCustomPriceInput.value = '';
        billingUnitSelect.innerHTML = '';
        const baseOpt = document.createElement('option');
        baseOpt.value = 'base';
        baseOpt.textContent = item.unit || 'unit';
        billingUnitSelect.appendChild(baseOpt);
      }

      function recalcBillTotals() {
        let subtotal = 0;
        let totalTax = 0;
        currentBillItems.forEach(it => {
          subtotal += Number(it.totalPrice) || 0;
          totalTax += Number(it.taxAmount) || 0;
        });
        const discount = Number(billDiscountEl.value) || 0;
        
        // Calculate raw total first
        const rawTotal = Math.max(0, subtotal + totalTax - discount);
        
        // ROUND OFF to nearest integer (₹1)
        const total = Math.round(rawTotal);
        
        billSubtotalEl.textContent = '₹' + fmt(subtotal);
        billTotalTaxEl.textContent = '₹' + fmt(totalTax);
        billTotalEl.textContent = '₹' + fmt(total); // Displays rounded amount
      }

      billDiscountEl.addEventListener('input', recalcBillTotals);

      function renderBillItems() {
        billItemsList.innerHTML = '';
        currentBillItems.forEach((it, idx) => {
          const row = document.createElement('tr');
          // Inside renderBillItems() function
           row.innerHTML = `
           <td data-label="Item">
           <div style="font-weight:bold;">${escapeHtml(it.name)}</div>
           <div class="text-xs muted">${it.variant ? '(' + escapeHtml(it.variant) + ')' : ''}</div>
           </td>
          <td data-label="Qty" style="font-weight:bold;">${fmtQty(it.quantity)} ${escapeHtml(it.unit || '')}</td>
          <td data-label="Rate">₹${fmt(it.pricePerUnit)}</td>
          <td data-label="Tax">₹${fmt(it.taxAmount)} <small class="muted">(${fmtQty(it.taxPercent)}%)</small></td>
          <td data-label="Total" style="color:var(--primary); font-weight:bold;">₹${fmt(it.totalPrice + it.taxAmount)}</td>
          <td class="actions-cell">
           <button class="btn-small delete" style="width:100%; padding:8px; background:rgba(239,68,68,0.15); color:#fca5a5;" data-index="${idx}">
            Remove Item
          </button>
          </td>
     `;
          billItemsList.appendChild(row);
        });
        recalcBillTotals();
      }

      if (billingForm) {
        billingForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const productId = selectedProductIdInput.value;
          if (!productId) {
            alert('Select a product first.');
            return;
          }
          const inv = getInventory();
          const item = inv.find(i => String(i.id) === String(productId));
          if (!item) {
            alert('Product not found in inventory.');
            return;
          }
          const qty = Number(billingQuantityInput.value) || 0;
          if (qty <= 0) {
            alert('Enter a valid quantity.');
            return;
          }
          const defaultPrice = item.pricePerUnit || 0;
          const customPrice = Number(billingCustomPriceInput.value);
          const pricePerUnit = customPrice > 0 ? customPrice : (Number(billingPriceInput.value) || defaultPrice);
          const unit = item.unit;
          
          if (qty > item.stock) {
            if (!confirm('Quantity exceeds available stock. Continue?')) {
              return;
            }
          }
          
          // --- NEW: CONSOLIDATION LOGIC ---
          const existingItem = currentBillItems.find(it => 
            String(it.productId) === String(item.id) && 
            it.pricePerUnit === pricePerUnit
          );

          if (existingItem) {
            // Update existing item
            existingItem.quantity += qty;
            
            existingItem.totalPrice = existingItem.quantity * existingItem.pricePerUnit;
            existingItem.taxAmount = (existingItem.totalPrice * existingItem.taxPercent) / 100;
            
            existingItem.stockReduced += qty;
            if (existingItem.linksToProductId) {
              const conversionFactor = Number(item.conversionFactor) || 0;
              existingItem.rawStockToReduce += (qty * conversionFactor);
            }
            
          } else {
            // Add as new item (original logic)
            const totalPrice = qty * pricePerUnit; // This is now Taxable Value
            const taxPercent = Number(item.taxPercent) || 0;
            const taxAmount = (totalPrice * taxPercent) / 100;
            
            let stockReduced = qty;
            let rawStockToReduce = 0;
            let linkedProductId = item.linksToProductId;
            if (linkedProductId) {
               const conversionFactor = Number(item.conversionFactor) || 0;
               rawStockToReduce = qty * conversionFactor;
            }

            currentBillItems.push({
              productId: item.id,
              name: item.name,
              variant: item.variant,
              unit: unit,
              quantity: qty,
              pricePerUnit: pricePerUnit,
              totalPrice: totalPrice, // Taxable value
              
              buyPrice: item.buyPrice || 0,
              taxPercent: taxPercent,
              taxAmount: taxAmount,
              
              stockReduced: stockReduced,
              linksToProductId: linkedProductId,
              rawStockToReduce: rawStockToReduce
            });
          }
          // --- END: CONSOLIDATION LOGIC ---

          renderBillItems();
          billingQuantityInput.value = 1;  // keep default 1
          billingCustomPriceInput.value = '';

          // 🔔 Toast for adding item
          showToast(`${item.name} added (Qty: ${fmtQty(qty)}).`);


        });
      }

          if (billItemsList) {
        billItemsList.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete')) {
            const idx = Number(e.target.dataset.index);
            if (!isNaN(idx)) {
              const removed = currentBillItems[idx];  // capture before removal
              currentBillItems.splice(idx, 1);
              renderBillItems();

              // 🔔 Toast for deleting item
              if (removed) {
                showToast(`${removed.name} removed (Qty: ${fmtQty(removed.quantity)}).`);
              }
            }
          }
        });
      }


      if (clearBillBtn) {
        clearBillBtn.addEventListener('click', () => {
          if (!currentBillItems.length && !customerNameInput.value && !customerPhoneInput.value && !Number(billDiscountEl.value)) return;
          if (!confirm('Clear current bill?')) return;
          currentBillItems = [];
          renderBillItems();
          customerNameInput.value = '';
          customerPhoneInput.value = '';
          billDiscountEl.value = 0;
          billingQuantityInput.value = '';
          billingCustomPriceInput.value = '';
          selectedProductIdInput.value = '';
          selectedProductName.textContent = 'No product selected';
          selectedProductPriceInfo.textContent = '';
          recalcBillTotals();
        });
      }
      
      /* -------------------------------------------
         NEW: PRODUCT DROPDOWN LOGIC
         ------------------------------------------- */
      function populateProductSelectDropdown() {
        if (!productSelectDropdown) return;
        const inv = getInventory();
        productSelectDropdown.innerHTML = '<option value="">Select product from list...</option>';
        
        inv.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = `${item.name} (${item.variant || item.unit}) | Stock: ${fmtQty(item.stock)} | ₹${fmt(item.pricePerUnit)}`;
          productSelectDropdown.appendChild(opt);
        });
      }

      function handleProductSelectChange(e) {
        const productId = e.target.value;
        if (!productId) return;
        
        const item = getInventory().find(i => String(i.id) === String(productId));
        
        if (item) {
          // 1. Select the product for billing
          selectProductForBilling(item);
          
          // 2. Highlight and scroll to the card in the grid
          document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
          const card = document.querySelector(`.product-card[data-id="${productId}"]`);
          if (card) {
            card.classList.add('selected');
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
          
          // 3. Reset dropdown and focus Qty
          e.target.value = '';
          billingQuantityInput.focus();
        }
      }
      
      if (productSelectDropdown) {
        productSelectDropdown.addEventListener('change', handleProductSelectChange);
      }

            /* PRINT MODAL HANDLER */
      const printModal = document.getElementById('print-modal');
      const modalText = document.getElementById('print-modal-text');
      const modalMeta = document.getElementById('print-modal-meta');
      const modalPrintNow = document.getElementById('modal-print-now');
      const modalWhatsapp = document.getElementById('modal-whatsapp');
      const modalSkip = document.getElementById('modal-skip');
      const modalCloseBtn = document.getElementById('print-modal-close');
      const modalBackdrop = printModal.querySelector('.modal-backdrop');
      
      // UPI ELEMENTS
      const modalShowUpiBtn = document.getElementById('modal-show-upi');
      const upiSection = document.getElementById('upi-section');
      const upiCanvas = document.getElementById('upi-qr-canvas');
      const upiStatusText = document.getElementById('upi-status-text');

      let lastCompletedSale = null;

      function openPrintModal(sale) {
        lastCompletedSale = sale;
        modalText.textContent = 'The sale was saved successfully. What would you like to do?';
        modalMeta.textContent = `Bill No: ${sale.billNo || ''} • Total: ₹${fmt(sale.total)}`;
        
        // Reset UPI section on open
        upiSection.style.display = 'none';
        
        printModal.classList.add('open');
      }

      function closePrintModal() {
        printModal.classList.remove('open');
        lastCompletedSale = null;
      }

      modalPrintNow.addEventListener('click', () => {
        if (!lastCompletedSale) return closePrintModal();
        printInvoice(lastCompletedSale, { autoPrint: true, layout: 'thermal' });
        closePrintModal();
      });

      // NEW: open WhatsApp modal (auto-fill customer phone if available)
      if (modalWhatsapp) {
        modalWhatsapp.addEventListener('click', () => {
          if (!lastCompletedSale) return closePrintModal();
          openWhatsappModalFromSale(lastCompletedSale);
        });
      }
      
      // NEW: Show UPI QR
      if (modalShowUpiBtn) {
          modalShowUpiBtn.addEventListener('click', () => {
              if (!lastCompletedSale) return;
              
              const shop = getShopSettings();
              if (!shop.upiId) {
                  alert("Please go to Settings and save your UPI ID first.");
                  return;
              }
              
              const amount = lastCompletedSale.total;
              if (amount <= 0) {
                  alert("Bill amount is 0. Cannot generate QR.");
                  return;
              }
              
              // Generate Deep Link
              // tr = transaction ref (optional), tn = transaction note
              const upiLink = `upi://pay?pa=${shop.upiId}&pn=${encodeURIComponent(shop.payeeName || 'Shop')}&am=${amount}&tn=Bill_${lastCompletedSale.billNo}`;
              
              // Generate QR
              const qr = new QRious({
                  element: upiCanvas,
                  value: upiLink,
                  size: 180
              });
              
              upiStatusText.textContent = `Scan to pay ₹${amount}`;
              upiSection.style.display = 'block';
              
          });
      }

      modalSkip.addEventListener('click', closePrintModal);
      modalCloseBtn.addEventListener('click', closePrintModal);
      modalBackdrop.addEventListener('click', closePrintModal);
      document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape' && printModal.classList.contains('open')) {
          closePrintModal();
        }
      });

            /* WHATSAPP MODAL HANDLER */
      const whatsappModal = document.getElementById('whatsapp-modal');
      const whatsappNumberInput = document.getElementById('whatsapp-number');
      const whatsappSendBtn = document.getElementById('whatsapp-send');
      const whatsappCancelBtn = document.getElementById('whatsapp-cancel');
      const whatsappCloseBtn = document.getElementById('whatsapp-close-btn');
      const whatsappBackdrop = whatsappModal ? whatsappModal.querySelector('.modal-backdrop') : null;

      function openWhatsappModalFromSale(sale) {
        if (!whatsappModal) return;
        const phone = sale && sale.customer && sale.customer.phone
          ? String(sale.customer.phone)
          : '';
        whatsappNumberInput.value = phone;   // auto-fill from customer profile (can be empty)
        whatsappModal.classList.add('open');
        whatsappModal.setAttribute('aria-hidden', 'false');
        whatsappNumberInput.focus();
      }

      function closeWhatsappModal() {
        if (!whatsappModal) return;
        whatsappModal.classList.remove('open');
        whatsappModal.setAttribute('aria-hidden', 'true');
      }

      if (whatsappCancelBtn) whatsappCancelBtn.addEventListener('click', closeWhatsappModal);
      if (whatsappCloseBtn) whatsappCloseBtn.addEventListener('click', closeWhatsappModal);
      if (whatsappBackdrop) whatsappBackdrop.addEventListener('click', closeWhatsappModal);

            if (whatsappSendBtn) {
        whatsappSendBtn.addEventListener('click', () => {
          if (!lastCompletedSale) {
            closeWhatsappModal();
            return;
          }

          const raw = (whatsappNumberInput.value || '').trim();
          if (!raw) {
            alert('Please enter a WhatsApp number.');
            whatsappNumberInput.focus();
            return;
          }

          // Strip non-digits so +91 / spaces etc. are ok
          const digits = raw.replace(/\D/g, '');
          if (!digits) {
            alert('Please enter a valid WhatsApp number.');
            return;
          }

          const sale = lastCompletedSale;

          // ✅ Build THERMAL-style invoice text (3-inch format)
          const message = buildThermalWhatsappText(sale);

          const waUrl = `https://wa.me/${digits}?text=${encodeURIComponent('```' + message + '```')}`;

          // ✅ Open WhatsApp FIRST (less likely to be blocked)
          window.open(waUrl, '_blank');

          // ✅ Open THERMAL print view (same format as text, for screenshot/PDF)
          printInvoice(sale, { autoPrint: false, layout: 'thermal' });

          closeWhatsappModal();
          closePrintModal();

          if (typeof showToast === 'function') {
            showToast('Opening WhatsApp…');
          }
        });
      }    


      /* PRINTING: thermal & detailed */
      function printInvoice(sale, options) {
        const layout = (options && options.layout) || 'thermal';
        const shop = getShopSettings();

        if (layout === 'thermal') {
          const widthMM = 80; // 3 inch ~ 76-80mm
          const headerHtml = `
            <div class="store-name">${escapeHtml(shop.name || 'Shop')}</div>
            <div class="store-sub">${escapeHtml(shop.address || '')}</div>
            ${shop.gst ? `<div class="meta">GST: ${escapeHtml(shop.gst)}</div>` : ''}
            <div class="meta">Bill No: ${sale.billNo || ''}</div>
            <div class="meta">Date: ${new Date(sale.date).toLocaleString()}</div>
            <div class="meta">
              ${sale.customer && (sale.customer.name || sale.customer.phone)
                ? `Customer: ${escapeHtml(sale.customer.name || '')} ${sale.customer.phone ? '(' + escapeHtml(sale.customer.phone) + ')' : ''}`
                : 'Customer: Walk-in'}
            </div>
          `;
          let itemsHtml = '';
          sale.items.forEach(it => {
            const itemTotal = (it.totalPrice || 0) + (it.taxAmount || 0);
            itemsHtml += `
              <div class="item">
                <div class="i-left">
                  ${escapeHtml(it.name)} ${it.variant ? '(' + escapeHtml(it.variant) + ')' : ''}<br>
                  <span class="item-meta">${fmtQty(it.quantity)} ${escapeHtml(it.unit || '')} @ ₹${fmt(it.pricePerUnit)}</span>
                </div>
                <div class="i-right">₹${fmt(itemTotal)}</div>
              </div>
            `;
          });

          const totalsHtml = `
            <div class="divider"></div>
            <div class="tot-row"><div>Subtotal</div><div>₹${fmt(sale.subtotal)}</div></div>
            <div class="tot-row"><div>Tax</div><div>₹${fmt(sale.totalTax)}</div></div>
            <div class="tot-row"><div>Discount</div><div>₹${fmt(sale.discount)}</div></div>
            <div class="tot-row big"><div>Total</div><div>₹${fmt(sale.total)}</div></div>
            <div class="divider"></div>
            <div class="thank">Thank you! Visit again.</div>
          `;

          const thermalStyles = `
            <style>
              @page { size: ${widthMM}mm auto; margin: 2mm; }
              html, body { width: ${widthMM}mm; margin:0; padding:0; font-family: 'Courier New', Courier, monospace; font-size:11px; color:#000; }
              .receipt { padding:4px 6px; box-sizing:border-box; width:100%; }
              .store-name { text-align:center; font-weight:800; font-size:12px; margin-bottom:2px; }
              .store-sub { text-align:center; font-size:10px; margin-bottom:4px; color:#222; }
              .meta { font-size:9px; margin-bottom:2px; }
              .divider { border-top:1px dashed #000; margin:6px 0; }
              .item { display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:2px; }
              .item-meta { color:#333; font-size:10px; margin-bottom:2px; }
              .i-left { max-width:58%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
              .i-right { text-align:right; min-width:32%; }
              .tot-row { display:flex; justify-content:space-between; font-size:11px; margin-top:4px; }
              .tot-row.big { font-weight:800; font-size:12px; margin-top:8px; }
              .thank { text-align:center; margin-top:8px; font-size:10px; }
              img { display:none !important; }
            </style>
          `;

          const html = `
            <!doctype html>
            <html><head><meta charset="utf-8">${thermalStyles}</head><body>
              <div class="receipt">
                ${headerHtml}
                ${itemsHtml}
                ${totalsHtml}
              </div>
            </body></html>
          `;

          const w = window.open('', '_blank', 'height=600,width=360');
          if (!w) {
            alert('Popup blocked: allow popups for this site to print receipts.');
            return;
          }
          w.document.open();
          w.document.write(html);
          w.document.close();
          w.focus();
          if (options && options.autoPrint) {
            setTimeout(() => {
              try { w.print(); } catch (e) {}
              try { w.close(); } catch (e) {}
            }, 300);
          }
          return;
        }

        // Detailed layout using hidden template
        const printableArea = document.getElementById('invoice-to-print');
        if (!printableArea) return;

        const invoiceItems = document.getElementById('invoice-items');
        const invoiceDate = document.getElementById('invoice-date');
        const invoiceSubtotal = document.getElementById('invoice-subtotal');
        const invoiceTax = document.getElementById('invoice-tax'); // New
        const invoiceDiscount = document.getElementById('invoice-discount');
        const invoiceTotal = document.getElementById('invoice-total');
        const invoiceCustomer = document.getElementById('invoice-customer');
        const invoiceBillNo = document.getElementById('invoice-bill-no');
        const headerShopName = document.getElementById('header-shop-name');
        const headerShopAddress = document.getElementById('header-shop-address');
        const invoiceGst = document.getElementById('invoice-gst');

        if (headerShopName) headerShopName.textContent = shop.name || 'Shop';
        if (headerShopAddress) headerShopAddress.textContent = shop.address || '';
        if (invoiceGst) invoiceGst.textContent = shop.gst ? 'GST: ' + shop.gst : '';

        invoiceDate.textContent = new Date(sale.date).toLocaleString();
        invoiceBillNo.textContent = sale.billNo ? `Bill No: ${sale.billNo}` : '';
        invoiceSubtotal.textContent = `₹${fmt(sale.subtotal)}`;
        invoiceTax.textContent = `₹${fmt(sale.totalTax)}`;
        invoiceDiscount.textContent = `₹${fmt(sale.discount)}`;
        invoiceTotal.textContent = `₹${fmt(sale.total)}`;
        invoiceCustomer.textContent = sale.customer && (sale.customer.name || sale.customer.phone)
          ? `Customer: ${sale.customer.name || ''} ${sale.customer.phone ? '('+sale.customer.phone+')' : ''}`
          : 'Customer: Walk-in';

        invoiceItems.innerHTML = '';
        sale.items.forEach(item => {
          const itemTotal = (item.totalPrice || 0) + (item.taxAmount || 0);
          invoiceItems.innerHTML += `
            <tr>
              <td>${escapeHtml(item.name)} ${item.variant ? '(' + escapeHtml(item.variant) + ')' : ''}</td>
              <td style="text-align:right;">${fmtQty(item.quantity)} ${escapeHtml(item.unit || '')}</td>
              <td>₹${fmt(item.pricePerUnit)}</td>
              <td style="text-align:right;">₹${fmt(item.taxAmount)}</td>
              <td style="text-align:right;">₹${fmt(itemTotal)}</td>
            </tr>
          `;
        });



        const printWindow = window.open('', '_blank', 'height=700,width=900');
        if (!printWindow) {
          alert('Popup blocked: allow popups for this site to print invoices.');
          return;
        }
        printWindow.document.open();
        printWindow.document.write(`
          <!doctype html>
          <html><head><meta charset="utf-8">
          <title>Invoice</title>
          <style>
            body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; padding: 16px; }
            table { width:100%; border-collapse:collapse; font-size:13px; }
            th, td { border-bottom:1px solid #e5e7eb; padding:4px 6px; text-align:left; }
            hr { border:0; border-top:1px solid #e5e7eb; margin:8px 0; }
          </style>
          </head><body>
            ${printableArea.innerHTML}
          </body></html>
        `);
        printWindow.document.close();
        printWindow.focus();
        if (options && options.autoPrint) {
          setTimeout(() => {
            try { printWindow.print(); } catch (e) {}
            try { printWindow.close(); } catch (e) {}
          }, 300);
        }
      }

      if (completeSaleBtn) {
        completeSaleBtn.addEventListener('click', () => {
          if (!currentBillItems.length) {
            alert('No items in bill.');
            return;
          }
          
          let subtotal = 0;
          let totalTax = 0;
          currentBillItems.forEach(it => {
            subtotal += Number(it.totalPrice) || 0;
            totalTax += Number(it.taxAmount) || 0;
          });
          
          const discount = Number(billDiscountEl.value) || 0;
          const rawTotal = Math.max(0, subtotal + totalTax - discount);
          const total = Math.round(rawTotal); // The rounding logic
          
          const customer = {
            name: (customerNameInput.value || '').trim(),
            phone: (customerPhoneInput.value || '').trim()
          };
          
          // Save customer for auto-fill
          saveCustomer(customer.name, customer.phone);

          const inv = getInventory();
          currentBillItems.forEach(it => {
            // 1. Reduce stock of the item sold
            const p = inv.find(i => String(i.id) === String(it.productId));
            if (p) {
              p.stock = (Number(p.stock) || 0) - (Number(it.stockReduced) || 0);
              if (p.stock < 0) p.stock = 0;
            }
            
            // 2. Reduce stock of the linked raw item
            if (it.linksToProductId && it.rawStockToReduce > 0) {
              const rawP = inv.find(i => String(i.id) === String(it.linksToProductId));
              if (rawP) {
                rawP.stock = (Number(rawP.stock) || 0) - (Number(it.rawStockToReduce) || 0);
                if (rawP.stock < 0) rawP.stock = 0;
              }
            }
          });
          saveInventory(inv);
          displayInventory(); // Refresh inventory list view

          const sale = {
            id: Date.now(),
            date: new Date().toISOString(),
            billNo: getNextBillNo(),
            customer,
            items: currentBillItems.map(it => Object.assign({}, it)), // Save all item details
            subtotal,
            totalTax, // Save total tax
            discount,
            total
          };

          const sales = getSales();
          sales.push(sale);
          saveSales(sales);

          openPrintModal(sale);
          showToast("Sale Completed Successfully.");
          
          populateProductSelectDropdown(); // NEW: Refresh stock in dropdown

          // reset bill
          currentBillItems = [];
          renderBillItems();
          customerNameInput.value = '';
          customerPhoneInput.value = '';
          billDiscountEl.value = 0;
          billingQuantityInput.value = '';
          billingCustomPriceInput.value = '';
          selectedProductIdInput.value = '';
          selectedProductName.textContent = 'No product selected';
          selectedProductPriceInfo.textContent = '';
          recalcBillTotals();
        });
      }

      // Build thermal-style text invoice for WhatsApp
      function buildThermalWhatsappText(sale) {
        const shop = getShopSettings();
        // 1. REDUCED WIDTH to prevent wrapping on small screens
        const lineWidth = 28; 

        function center(text) {
          text = String(text || '');
          if (text.length >= lineWidth) return text.substring(0, lineWidth);
          const pad = Math.floor((lineWidth - text.length) / 2);
          return ' '.repeat(pad) + text;
        }

        // 2. NEW: Pad with DOTS instead of spaces (Visual guide helps alignment)
        function padRightDots(text, width) {
          text = String(text || '');
          if (text.length >= width) return text.slice(0, width);
          return text + ' '.repeat(width - text.length); // Using spaces is cleaner for Code Block
        }

        function padLeft(text, width) {
          text = String(text || '');
          if (text.length >= width) return text.slice(-width);
          return ' '.repeat(width - text.length) + text;
        }

        const sep = '-'.repeat(lineWidth);
        let out = '';

        // Header
        out += center(shop.name || 'Shop') + '\n';
        if (shop.address) out += center(shop.address) + '\n';
        out += center(`Bill: ${sale.billNo || ''}`) + '\n';
        
        const d = new Date(sale.date);
        // Short date format to save space
        const dateStr = `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${d.getMinutes()}`;
        out += center(dateStr) + '\n';
        out += sep + '\n';

        // Items Logic
        (sale.items || []).forEach(it => {
          // Format: "Qty x ItemName"
          // e.g., "2 x Groundnut Oil"
          const prefix = `${fmtQty(it.quantity)} x `;
          const name = it.name || '';
          const variant = it.variant ? `(${it.variant})` : '';
          const fullName = (prefix + name + ' ' + variant).trim();

          // Calculate Price String
          const itemTotal = (Number(it.totalPrice) || 0) + (Number(it.taxAmount) || 0);
          const totalStr = fmt(itemTotal); // e.g. "150.00" (6 chars)
          
          // Calculate space left for name
          // lineWidth - 1 space - price length
          const maxNameLen = lineWidth - totalStr.length - 1;
          
          // Create the line: "Name....... 150.00"
          const leftPart = padRightDots(fullName, maxNameLen);
          
          out += leftPart + ' ' + totalStr + '\n';
        });

        out += sep + '\n';

        const subtotal = Number(sale.subtotal) || 0;
        const taxTotal = Number(sale.totalTax) || 0;
        const discount = Number(sale.discount) || 0;
        const grandTotal = Number(sale.total) || 0;

        // Footer Totals
        out += padRightDots('Subtotal', 18) + padLeft(fmt(subtotal), lineWidth - 18) + '\n';
        if(taxTotal > 0) {
            out += padRightDots('Tax', 18) + padLeft(fmt(taxTotal), lineWidth - 18) + '\n';
        }
        if(discount > 0) {
            out += padRightDots('Discount', 18) + padLeft(fmt(discount), lineWidth - 18) + '\n';
        }
        
        out += sep + '\n';
        // Grand Total Centered and Spaced
        out += center(`* TOTAL: ₹${fmt(grandTotal)} *`) + '\n';
        out += sep + '\n';
        out += center('Thank You!') + '\n';

        return out;
      }
      
      
      /* -------------------------------------------
         LABEL GENERATION LOGIC
         ------------------------------------------- */
      const labelModal = document.getElementById('label-modal');
      const labelCloseBtn = document.getElementById('label-close-btn');
      const labelPrintBtn = document.getElementById('label-print-btn');
      const labelQrCanvas = document.getElementById('label-qr-canvas');
      
      function openLabelModal(product) {
          document.getElementById('label-product-name').textContent = product.name;
          document.getElementById('label-product-variant').textContent = product.variant || '';
          document.getElementById('label-product-price').textContent = `₹${fmt(product.pricePerUnit)}`;
          
          // Generate QR containing Product ID
          new QRious({
              element: labelQrCanvas,
              value: String(product.id),
              size: 150
          });
          
          labelModal.classList.add('open');
      }
      
      function closeLabelModal() {
          labelModal.classList.remove('open');
      }
      
      if(labelCloseBtn) labelCloseBtn.addEventListener('click', closeLabelModal);
      if(labelModal) labelModal.querySelector('.modal-backdrop').addEventListener('click', closeLabelModal);
      
      if(labelPrintBtn) {
          labelPrintBtn.addEventListener('click', () => {
              const content = document.getElementById('label-print-area').innerHTML;
              const w = window.open('', '_blank', 'height=400,width=400');
              w.document.write(`<html><head><title>Label</title></head><body style="text-align:center;">${content}</body></html>`);
              w.document.close();
              w.focus();
              setTimeout(() => {
                  w.print();
                  w.close();
              }, 500);
          });
      }
      
      /* -------------------------------------------
         BARCODE SCANNER LOGIC
         ------------------------------------------- */
      const scannerModal = document.getElementById('scanner-modal');
      const scannerCloseBtn = document.getElementById('scanner-close-btn');
      let html5QrcodeScanner = null;
      
      if(scanBarcodeBtn) {
          scanBarcodeBtn.addEventListener('click', () => {
              scannerModal.classList.add('open');
              // Add a small delay to ensure the Modal is visible before camera starts
              setTimeout(() => {
                  startScanner();
              }, 300);
          });
      }
      
      function closeScannerModal() {
          if(html5QrcodeScanner) {
              try {
                html5QrcodeScanner.clear().catch(error => {
                    console.error("Failed to clear html5QrcodeScanner. ", error);
                });
              } catch(e) { console.log(e); }
          }
          scannerModal.classList.remove('open');
      }
      
      if(scannerCloseBtn) scannerCloseBtn.addEventListener('click', closeScannerModal);
      if(scannerModal) scannerModal.querySelector('.modal-backdrop').addEventListener('click', closeScannerModal);
      
      function startScanner() {
          // 1. Clean up any existing scanner instance to prevent errors
          if(html5QrcodeScanner) {
            try { html5QrcodeScanner.clear(); } catch(e) {}
          }

          // 2. Initialize with Rear Camera settings
          html5QrcodeScanner = new Html5QrcodeScanner(
              "scanner-preview",
              { 
                  fps: 10, 
                  qrbox: {width: 250, height: 250},
                  aspectRatio: 1.0, // Important for mobile portrait view
                  rememberLastUsedCamera: false, // Set to FALSE to force "environment" preference every time
                  videoConstraints: {
                      facingMode: "environment" // This requests the Rear Camera
                  }
              },
              /* verbose= */ false);
          
          html5QrcodeScanner.render(onScanSuccess, onScanFailure);
      }
      
      function onScanSuccess(decodedText, decodedResult) {
          // decodedText contains the Product ID from the QR
          // Stop scanning
          if(html5QrcodeScanner) {
              html5QrcodeScanner.clear();
          }
          scannerModal.classList.remove('open');
          playToastSound();
          
          // Find Product
          const inv = getInventory();
          // Check both ID and direct string match
          const item = inv.find(i => String(i.id) === String(decodedText));
          
          if(item) {
              selectProductForBilling(item);
              // Auto-fill Qty 1 and highlight it
              billingQuantityInput.value = 1;
              billingQuantityInput.focus();
              showToast(`Scanned: ${item.name}`);
          } else {
              alert('Product not found for this code: ' + decodedText);
          }
      }
      
      function onScanFailure(error) {
          // Keep this empty to avoid console spam while scanning
      }


      /* -------------------------------------------
         REPORTS PAGE LOGIC
         ------------------------------------------- */
      const reportStartDate = document.getElementById('report-start-date');
      const reportEndDate = document.getElementById('report-end-date');
      const reportItemSelect = document.getElementById('report-item-select');
      const reportCustomerSearch = document.getElementById('report-customer-search');
      const applyDateBtn = document.getElementById('apply-date-range-btn');
      const presetToday = document.getElementById('preset-today');
      const preset7 = document.getElementById('preset-7');
      const preset30 = document.getElementById('preset-30');
      const presetMonth = document.getElementById('preset-month');
      const exportFormatSelect = document.getElementById('export-format');
      const exportRangeBtn = document.getElementById('export-range-btn');
      const printReportBtn = document.getElementById('print-report-btn');
      const reportsList = document.getElementById('reports-list');
      const reportsSummary = document.getElementById('reports-summary');
      const topItemsList = document.getElementById('top-items-list');
      const revenueTrendCanvas = document.getElementById('revenue-trend');
      
      const reportTabs = document.querySelectorAll('.tabs .tab');
      const reportPanels = document.querySelectorAll('.report-panel');
      
      const partyWiseContainer = document.getElementById('party-wise-container');
      const showPartyWiseBtn = document.getElementById('show-party-wise-btn');
      
      // New report panel elements
      const topProfitItemsList = document.getElementById('top-profit-items-list');
      const topProfitCustomersList = document.getElementById('top-profit-customers-list');
      const gstSummaryList = document.getElementById('gst-summary-list');
      const purchaseReportList = document.getElementById('purchase-report-list');


      let revenueChartInstance = null;
      let activeFilteredSales = [];
      let activeFilteredPurchases = [];

      function populateReportSelectors() {
        reportItemSelect.innerHTML = '<option value="">All</option>';
        const inv = getInventory();
        const seen = new Set();
        inv.forEach(i => {
          if (!seen.has(i.name)) {
            seen.add(i.name);
            const opt = document.createElement('option');
            opt.value = i.name;
            opt.textContent = i.name;
            reportItemSelect.appendChild(opt);
          }
        });
        
        // Also refresh customer datalist for filter
        populateCustomerDatalists();
      }

      function setDateRange(d1, d2) {
        reportStartDate.value = fmtDateInput(d1);
        reportEndDate.value = fmtDateInput(d2);
      }

      function todayRange() {
        const now = new Date();
        const d1 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const d2 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        setDateRange(d1, d2);
      }

      function lastNDaysRange(n) {
        const now = new Date();
        const d2 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const d1 = new Date(d2);
        d1.setDate(d1.getDate() - (n - 1));
        setDateRange(d1, d2);
      }

      function thisMonthRange() {
        const now = new Date();
        const d1 = new Date(now.getFullYear(), now.getMonth(), 1);
        const d2 = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        setDateRange(d1, d2);
      }

      if (presetToday) presetToday.addEventListener('click', () => { todayRange(); applyAndRenderReports(); });
      if (preset7) preset7.addEventListener('click', () => { lastNDaysRange(7); applyAndRenderReports(); });
      if (preset30) preset30.addEventListener('click', () => { lastNDaysRange(30); applyAndRenderReports(); });
      if (presetMonth) presetMonth.addEventListener('click', () => { thisMonthRange(); applyAndRenderReports(); });
      if (applyDateBtn) applyDateBtn.addEventListener('click', () => applyAndRenderReports());

      function applyAllFilters() {
        const sales = getSales();
        const purchases = getPurchases();
        
        let filteredSales = sales.slice();
        let filteredPurchases = purchases.slice();
        
        const sdVal = reportStartDate.value;
        const edVal = reportEndDate.value;
        
        if (sdVal && edVal) {
          filteredSales = filteredSales.filter(s => {
            const ymd = toLocalYMD(s.date);
            return ymd >= sdVal && ymd <= edVal;
          });
          filteredPurchases = filteredPurchases.filter(p => {
            const ymd = toLocalYMD(p.date);
            return ymd >= sdVal && ymd <= edVal;
          });
        }
        
        const itemName = (reportItemSelect.value || '').toLowerCase();
        if (itemName) {
          filteredSales = filteredSales.filter(s => Array.isArray(s.items) &&
            s.items.some(it => (it.name || '').toLowerCase().includes(itemName)));
          // Not filtering purchases by item name for now, but could
        }
        
        const customerSearch = (reportCustomerSearch.value || '').toLowerCase();
        if (customerSearch) {
          filteredSales = filteredSales.filter(s => {
            const name = (s.customer && s.customer.name || '').toLowerCase();
            const phone = (s.customer && s.customer.phone || '').toLowerCase();
            return name.includes(customerSearch) || phone.includes(customerSearch);
          });
        }

        filteredSales.sort((a,b) => new Date(a.date) - new Date(b.date));
        filteredPurchases.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        return { filteredSales, filteredPurchases };
      }

      function renderRevenueTrend(filtered) {
        if (!revenueTrendCanvas) return;
        const map = {};
        filtered.forEach(s => {
          const key = toLocalYMD(s.date);
          map[key] = (map[key] || 0) + (Number(s.total) || 0);
        });
        const labels = Object.keys(map).sort();
        const data = labels.map(k => map[k]);

        if (revenueChartInstance) {
          revenueChartInstance.destroy();
        }
        revenueChartInstance = new Chart(revenueTrendCanvas.getContext('2d'), {
          type: 'bar',
          data: { 
            labels, 
            datasets: [{ 
              label: 'Revenue', 
              data,
              backgroundColor: 'rgba(249, 115, 22, 0.6)',
              borderColor: 'rgba(249, 115, 22, 1)',
              borderWidth: 1
            }] 
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(148,163,184,0.1)' } },
              y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(148,163,184,0.1)' } }
            }
          }
        });
      }
      
      function renderTopList(element, data, nameKey, valueKey, valuePrefix) {
        if (!element) return;
        element.innerHTML = '';
        if (!data.length) {
          element.innerHTML = '<div class="muted text-xs">No data</div>';
          return;
        }
        data.forEach(row => {
          const div = document.createElement('div');
          div.className = 'card-subtle';
          div.style.padding = '6px 8px';
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;">
              <div>${escapeHtml(row[nameKey])}</div>
              <div>${valuePrefix}${fmt(row[valueKey])}</div>
            </div>
            ${row.meta ? `<div class="text-xs muted">${escapeHtml(row.meta)}</div>` : ''}
          `;
          element.appendChild(div);
        });
      }

      function renderTopItems(filtered) {
        if (!topItemsList) return;
        const map = {};
        filtered.forEach(s => {
          (s.items || []).forEach(it => {
            const key = it.name || 'Unknown';
            if (!map[key]) map[key] = { qty:0, total:0 };
            map[key].qty += Number(it.quantity) || 0;
            map[key].total += Number(it.totalPrice) || 0;
          });
        });
        const arr = Object.keys(map).map(name => ({
          name,
          qty: map[name].qty,
          total: map[name].total,
          meta: `Qty: ${fmtQty(map[name].qty)}`
        })).sort((a,b) => b.total - a.total).slice(0,10);

        renderTopList(topItemsList, arr, 'name', 'total', '₹');
      }

      function renderReportsTable(filtered) {
        if (!reportsList) return;
        reportsList.innerHTML = '';
        if (!filtered.length) {
          reportsList.innerHTML = '<tr><td colspan="7" class="text-xs muted">No bills in this range.</td></tr>';
          return;
        }
        filtered.slice().reverse().forEach(sale => {
          const tr = document.createElement('tr');
          const cust = sale.customer && (sale.customer.name || sale.customer.phone)
            ? `${sale.customer.name || ''} ${sale.customer.phone ? '(' + sale.customer.phone + ')' : ''}`
            : 'Walk-in';
            
          // Calculate profit per bill
          const cost = (sale.items || []).reduce((acc, it) => {
            return acc + (Number(it.quantity) || 0) * (Number(it.buyPrice) || 0);
          }, 0);
          const revenue = Number(sale.subtotal) || 0; // Subtotal is revenue before tax
          const profit = revenue - cost;
            
          tr.innerHTML = `
            <td data-label="Date">${escapeHtml(new Date(sale.date).toLocaleString())}</td>
            <td data-label="Bill No">${escapeHtml(String(sale.billNo || ''))}</td>
            <td data-label="Customer">${escapeHtml(cust)}</td>
            <td data-label="Items">${(sale.items || []).length}</td>
            <td data-label="Profit">₹${fmt(profit)}</td>
            <td data-label="Total" style="font-weight:bold; color:var(--primary);">₹${fmt(sale.total)}</td>
            <td data-label="Actions" class="actions-cell">
              <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn-small" data-action="view" data-id="${sale.id}">View</button>
                <button class="btn-small" data-action="print" data-id="${sale.id}">Print</button>
                <button class="btn-small delete" data-action="delete" data-id="${sale.id}">Delete</button>
              </div>
            </td>
          `;
          reportsList.appendChild(tr);
        });
      }

      if (reportsList) {
        reportsList.addEventListener('click', (e) => {
          const action = e.target.dataset.action;
          const id = e.target.dataset.id;
          if (!action || !id) return;

          const allSales = getSales();
          const sale = allSales.find(s => String(s.id) === String(id));
          if (!sale) return;

          if (action === 'print') {
            printInvoice(sale, { autoPrint: true, layout: 'thermal' });
            return;
          } else if (action === 'view') {
            printInvoice(sale, { autoPrint: false, layout: 'detailed' });
            return;
          } else if (action === 'delete') {
            if (!confirm('Delete this bill and restore stock to inventory? This will also remove associated purchase links.')) return;
            const inv = getInventory();
            (sale.items || []).forEach(it => {
              // 1. Restore stock of item sold
              const p = inv.find(i => String(i.id) === String(it.productId));
              if (p) {
                const restoredQty = Number(it.stockReduced || it.quantity || 0);
                p.stock = (Number(p.stock) || 0) + restoredQty;
              }
              // 2. Restore stock of linked raw item
              if (it.linksToProductId && it.rawStockToReduce > 0) {
                 const rawP = inv.find(i => String(i.id) === String(it.linksToProductId));
                 if (rawP) {
                   rawP.stock = (Number(rawP.stock) || 0) + (Number(it.rawStockToReduce) || 0);
                 }
              }
            });
            saveInventory(inv);
            displayInventory();
            renderProductGrid();
            populateProductSelectDropdown(); // NEW

            const remainingSales = allSales.filter(s => String(s.id) !== String(id));
            saveSales(remainingSales);

            applyAndRenderReports();
            return;
          }
        });
      }
      
      // Calculate profit for a single sale object
      function getSaleProfit(sale) {
        const cost = (sale.items || []).reduce((acc, it) => {
           return acc + (Number(it.quantity) || 0) * (Number(it.buyPrice) || 0);
        }, 0);
        const revenue = Number(sale.subtotal) || 0; // Subtotal (pre-tax)
        return revenue - cost;
      }

      function renderPartyWise(filtered) {
        partyWiseContainer.innerHTML = '';
        const map = {};
        filtered.forEach(s => {
          const key = (s.customer && (s.customer.phone || s.customer.name)) || 'Walk-in';
          if (!map[key]) {
            map[key] = { name: s.customer && s.customer.name || key, phone: s.customer && s.customer.phone || '', total:0, count:0 };
          }
          map[key].total += Number(s.total) || 0;
          map[key].count += 1;
        });
        const arr = Object.keys(map).map(k => map[k]).sort((a,b) => b.total - a.total);
        if (!arr.length) {
          partyWiseContainer.innerHTML = '<div class="muted text-xs">No data.</div>';
          return;
        }
        arr.forEach(row => {
          const div = document.createElement('div');
          div.className = 'party-row';
          const key = row.phone || row.name || 'Walk-in';
          div.dataset.partyKey = key;
          div.innerHTML = `
            <div>
              <div>${escapeHtml(row.name || 'Walk-in')}</div>
              <div class="text-xs muted">${row.phone ? escapeHtml(row.phone) : ''}</div>
            </div>
            <div style="text-align:right;">
              <div>₹${fmt(row.total)}</div>
              <div class="text-xs muted">${row.count} bill(s)</div>
            </div>
          `;
          partyWiseContainer.appendChild(div);
        });
      }

      if (showPartyWiseBtn) {
        showPartyWiseBtn.addEventListener('click', () => {
          const filtered = activeFilteredSales;
          renderPartyWise(filtered);
        });
      }

      if (partyWiseContainer) {
        partyWiseContainer.addEventListener('click', (e) => {
          const row = e.target.closest('.party-row');
          if (!row) return;
          const key = row.dataset.partyKey;
          if (!key) return;
          
          // Set the filter and re-apply
          reportCustomerSearch.value = key;
          applyAndRenderReports();
          
          // Switch to bills tab
          setActiveReportTab('list-view');
        });
      }

      function setActiveReportTab(tabName) {
        reportTabs.forEach(t => {
          t.classList.toggle('active', t.dataset.tab === tabName);
        });
        reportPanels.forEach(p => {
          p.style.display = (p.id === tabName) ? '' : 'none';
        });
      }

      reportTabs.forEach(tab => {
        tab.addEventListener('click', () => setActiveReportTab(tab.dataset.tab));
      });
      
      // NEW REPORTING FUNCTIONS
      function renderProfitSummary(filtered) {
        // 1. Top Items by Profit
        const itemMap = {};
        filtered.forEach(s => {
          (s.items || []).forEach(it => {
            const key = it.name || 'Unknown';
            const itemProfit = (Number(it.pricePerUnit) - Number(it.buyPrice)) * Number(it.quantity);
            if (!itemMap[key]) itemMap[key] = { profit: 0, qty: 0 };
            itemMap[key].profit += itemProfit;
            itemMap[key].qty += Number(it.quantity);
          });
        });
        const itemArr = Object.keys(itemMap).map(name => ({
          name,
          profit: itemMap[name].profit,
          meta: `Qty: ${fmtQty(itemMap[name].qty)}`
        })).sort((a,b) => b.profit - a.profit).slice(0, 10);
        renderTopList(topProfitItemsList, itemArr, 'name', 'profit', '₹');
        
        // 2. Top Customers by Profit
        const custMap = {};
        filtered.forEach(s => {
          const key = (s.customer && (s.customer.phone || s.customer.name)) || 'Walk-in';
          const saleProfit = getSaleProfit(s);
          if (!custMap[key]) {
            custMap[key] = { 
              name: s.customer && s.customer.name || key, 
              phone: s.customer && s.customer.phone || '', 
              profit: 0,
              count: 0
            };
          }
          custMap[key].profit += saleProfit;
          custMap[key].count += 1;
        });
        const custArr = Object.keys(custMap).map(k => ({
          name: custMap[k].name,
          profit: custMap[k].profit,
          meta: `${custMap[k].phone} (${custMap[k].count} bill/s)`
        })).sort((a,b) => b.profit - a.profit).slice(0, 10);
        renderTopList(topProfitCustomersList, custArr, 'name', 'profit', '₹');
      }
      
      function renderGstSummary(filtered) {
        const taxMap = {}; // { "5": { taxable: 100, tax: 5 }, "12": { ... } }
        filtered.forEach(s => {
          (s.items || []).forEach(it => {
            const rate = Number(it.taxPercent) || 0;
            if (!taxMap[rate]) taxMap[rate] = { taxable: 0, tax: 0 };
            taxMap[rate].taxable += Number(it.totalPrice) || 0; // totalPrice is pre-tax
            taxMap[rate].tax += Number(it.taxAmount) || 0;
          });
        });
        
        gstSummaryList.innerHTML = '';
        const rates = Object.keys(taxMap).sort((a,b) => Number(a) - Number(b));
        if (!rates.length) {
           gstSummaryList.innerHTML = '<tr><td colspan="3" class="text-xs muted">No tax data in this range.</td></tr>';
           return;
        }
        
        let totalTaxable = 0;
        let totalTax = 0;
        
        rates.forEach(rate => {
          const data = taxMap[rate];
          totalTaxable += data.taxable;
          totalTax += data.tax;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtQty(rate)}%</td>
            <td>₹${fmt(data.taxable)}</td>
            <td>₹${fmt(data.tax)}</td>
          `;
          gstSummaryList.appendChild(tr);
        });
        
        // Add footer row
        const tr = document.createElement('tr');
        tr.style.fontWeight = 'bold';
        tr.style.borderTop = '2px solid var(--muted-100)';
        tr.innerHTML = `
          <td>Total</td>
          <td>₹${fmt(totalTaxable)}</td>
          <td>₹${fmt(totalTax)}</td>
        `;
        gstSummaryList.appendChild(tr);
      }
      
      function renderPurchaseReport(filtered) {
         purchaseReportList.innerHTML = '';
         if (!filtered.length) {
            purchaseReportList.innerHTML = '<tr><td colspan="6" class="text-xs muted">No purchases in this range.</td></tr>';
            return;
         }
         let totalAmount = 0;
         filtered.slice().reverse().forEach(p => {
           totalAmount += Number(p.total) || 0;
           const tr = document.createElement('tr');
           tr.innerHTML = `
             <td>${escapeHtml(toLocalYMD(p.date))}</td>
             <td>${escapeHtml(p.supplierName)}</td>
             <td>${escapeHtml(p.productName)}</td>
             <td>${fmtQty(p.quantity)}</td>
             <td>₹${fmt(p.rate)}</td>
             <td>₹${fmt(p.total)}</td>
           `;
           purchaseReportList.appendChild(tr);
         });
         
         // Add footer row
         const tr = document.createElement('tr');
         tr.style.fontWeight = 'bold';
         tr.style.borderTop = '2px solid var(--muted-100)';
         tr.innerHTML = `
           <td colspan="5">Total Purchases</td>
           <td>₹${fmt(totalAmount)}</td>
         `;
         purchaseReportList.appendChild(tr);
      }

      function applyAndRenderReports() {
        const { filteredSales, filteredPurchases } = applyAllFilters();
        activeFilteredSales = filteredSales;
        activeFilteredPurchases = filteredPurchases;
        
        renderRevenueTrend(filteredSales);
        renderTopItems(filteredSales);
        renderReportsTable(filteredSales);
        renderPartyWise(filteredSales);
        
        // New reports
        renderProfitSummary(filteredSales);
        renderGstSummary(filteredSales);
        renderPurchaseReport(filteredPurchases);
        
        const totalBills = filteredSales.length;
        const totalRevenue = filteredSales.reduce((sum, s) => sum + (Number(s.total) || 0), 0);
        const totalProfit = filteredSales.reduce((sum, s) => sum + getSaleProfit(s), 0);
        const totalTax = filteredSales.reduce((sum, s) => sum + (Number(s.totalTax) || 0), 0);
        
        if (reportsSummary) {
          reportsSummary.innerHTML = `
            <strong>Bills:</strong> ${totalBills} &nbsp;
            <strong>Revenue:</strong> ₹${fmt(totalRevenue)} &nbsp;
            <strong>Profit:</strong> ₹${fmt(totalProfit)} &nbsp;
            <strong>Tax:</strong> ₹${fmt(totalTax)}
          `;
        }
      }

      // EXPORT
      if (exportRangeBtn) {
        exportRangeBtn.addEventListener('click', () => {
          const filtered = activeFilteredSales || applyAllFilters().filteredSales;
          
          const format = exportFormatSelect.value || 'json';
          if (format === 'json') {
             const dataToExport = {
                sales: filtered,
                purchases: activeFilteredPurchases
             };
             exportJSON(dataToExport, 'report_export.json');
             return;
          } 
            
          // CSV/XLSX: Export detailed item-wise list
          const rows = [];
          filtered.forEach(s => {
            (s.items || []).forEach(it => {
              const profit = (Number(it.pricePerUnit) - Number(it.buyPrice)) * Number(it.quantity);
              rows.push({
                billNo: s.billNo,
                date: new Date(s.date).toLocaleString(),
                customerName: s.customer && s.customer.name || '',
                customerPhone: s.customer && s.customer.phone || '',
                itemName: it.name,
                variant: it.variant,
                qty: it.quantity,
                unit: it.unit,
                buyPrice: it.buyPrice,
                rate: it.pricePerUnit,
                taxableValue: it.totalPrice,
                taxPercent: it.taxPercent,
                taxAmount: it.taxAmount,
                itemTotal: (it.totalPrice || 0) + (it.taxAmount || 0),
                profit: profit
              });
            });
          });
          
          const columns = [
              { key: 'billNo', label: 'Bill No' },
              { key: 'date', label: 'Date' },
              { key: 'customerName', label: 'Customer' },
              { key: 'customerPhone', label: 'Phone' },
              { key: 'itemName', label: 'Item' },
              { key: 'variant', label: 'Variant' },
              { key: 'qty', label: 'Qty' },
              { key: 'unit', label: 'Unit' },
              { key: 'buyPrice', label: 'Buy Price' },
              { key: 'rate', label: 'Sell Price (Rate)' },
              { key: 'taxableValue', label: 'Taxable Value' },
              { key: 'taxPercent', label: 'Tax %' },
              { key: 'taxAmount', label: 'Tax Amount' },
              { key: 'itemTotal', label: 'Item Total (w/ Tax)' },
              { key: 'profit', label: 'Profit (Est.)' }
          ];
          
          if (format === 'csv') {
            exportCSV(rows, columns, 'sales_export.csv');
          } else if (format === 'xlsx') {
            exportXLSX(rows, columns, 'sales_export.xlsx');
          }
        });
      }

      function exportJSON(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'export.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function exportCSV(rows, columns, filename) {
        const header = columns.map(c => `"${c.label}"`).join(',');
        const lines = rows.map(r => columns.map(c => {
          let v = r[c.key];
          if (v === undefined || v === null) v = '';
          v = String(v).replace(/"/g,'""');
          return `"${v}"`;
        }).join(','));
        const csv = [header].concat(lines).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'export.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function exportXLSX(rows, columns, filename) {
        const header = columns.map(c => c.label);
        const data = rows.map(r => columns.map(c => r[c.key]));
        const aoa = [header].concat(data);
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        XLSX.writeFile(wb, filename || 'export.xlsx');
      }

      // PRINT FILTERED REPORT RESULTS
      if (printReportBtn) {
        printReportBtn.addEventListener('click', () => {
          const filtered = activeFilteredSales || applyAllFilters().filteredSales;
          if (!filtered.length) {
            alert('No bills for the selected range.');
            return;
          }
          const shop = getShopSettings();
          const sdVal = reportStartDate.value;
          const edVal = reportEndDate.value;
          const rangeText = sdVal && edVal ? `${sdVal} to ${edVal}` : 'All dates';

          let rowsHtml = '';
          let totalProfit = 0;
          let grandTotal = 0;
          
          filtered.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(s => {
            const cust = s.customer && (s.customer.name || s.customer.phone)
              ? `${s.customer.name || ''} ${s.customer.phone ? '('+s.customer.phone+')' : ''}`
              : 'Walk-in';
            const profit = getSaleProfit(s);
            totalProfit += profit;
            grandTotal += Number(s.total) || 0;
              
            rowsHtml += `
              <tr>
                <td>${escapeHtml(new Date(s.date).toLocaleString())}</td>
                <td>${escapeHtml(String(s.billNo || ''))}</td>
                <td>${escapeHtml(cust)}</td>
                <td>${(s.items || []).length}</td>
                <td>₹${fmt(profit)}</td>
                <td>₹${fmt(s.total)}</td>
              </tr>
            `;
          });
          
          // Add summary row
          rowsHtml += `
            <tr style="font-weight:bold; border-top: 2px solid #333;">
              <td colspan="4">Total</td>
              <td>₹${fmt(totalProfit)}</td>
              <td>₹${fmt(grandTotal)}</td>
            </tr>
          `;

          const html = `
            <!doctype html>
            <html>
            <head>
              <meta charset="utf-8">
              <title>Sales Report</title>
              <style>
                body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; padding: 16px; font-size: 13px; }
                h2,h3 { margin: 0 0 4px 0; }
                .muted { color: #6b7280; font-size: 12px; }
                table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px; }
                th, td { border-bottom: 1px solid #e5e7eb; padding: 4px 6px; text-align: left; white-space: nowrap; }
                th { background: #f9fafb; }
                .summary { margin-top: 8px; font-size: 12px; }
              </style>
            </head>
            <body>
              <h2>${escapeHtml(shop.name || 'Shop')}</h2>
              <div class="muted">${escapeHtml(shop.address || '')}</div>
              ${shop.gst ? `<div class="muted">GST: ${escapeHtml(shop.gst)}</div>` : ''}
              <h3 style="margin-top:10px;">Sales Report</h3>
              <div class="muted">Range: ${escapeHtml(rangeText)}</div>
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Bill No</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Profit (Est.)</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${rowsHtml}
                </tbody>
              </table>
            </body>
            </html>
          `;
          const w = window.open('', '_blank', 'height=700,width=900');
          if (!w) {
            alert('Popup blocked: allow popups for this site to print reports.');
            return;
          }
          w.document.open();
          w.document.write(html);
          w.document.close();
          w.focus();
          setTimeout(() => {
            try { w.print(); } catch(e) {}
          }, 300);
        });
      }

      /* -------------------------------------------
         INITIALIZATION
         ------------------------------------------- */
      updateShopUI();
      displayInventory();
      renderProductGrid();
      populateReportSelectors();
      updateLinkedProductOptions();
      displayPurchases();
      populateProductSelectDropdown(); // NEW
      todayRange();
      applyAndRenderReports();
      initFromHash();
    })();
  </script>
</body>
</html>
